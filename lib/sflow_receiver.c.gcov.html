<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - lib/sflow_receiver.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">lib</a> - sflow_receiver.c<span style="font-size: 80%;"> (source / <a href="sflow_receiver.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">259</td>
            <td class="headerCovTableEntry">468</td>
            <td class="headerCovTableEntryLo">55.3 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-09-14 01:02:56</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">25</td>
            <td class="headerCovTableEntry">57</td>
            <td class="headerCovTableEntryLo">43.9 %</td>
          </tr>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">57</td>
            <td class="headerCovTableEntry">125</td>
            <td class="headerCovTableEntryLo">45.6 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : /* Copyright (c) 2002-2009 InMon Corp. Licensed under the terms of either the</a>
<span class="lineNum">       2 </span>                :            :  *   Sun Industry Standards Source License 1.1, that is available at:
<span class="lineNum">       3 </span>                :            :  *    http://host-sflow.sourceforge.net/sissl.html
<span class="lineNum">       4 </span>                :            :  * or the InMon sFlow License, that is available at:
<span class="lineNum">       5 </span>                :            :  *    http://www.inmon.com/technology/sflowlicense.txt
<span class="lineNum">       6 </span>                :            :  */
<span class="lineNum">       7 </span>                :            : 
<span class="lineNum">       8 </span>                :            : #ifndef __CHECKER__            /* Don't run sparse on anything in this file. */
<span class="lineNum">       9 </span>                :            : 
<span class="lineNum">      10 </span>                :            : #include &lt;assert.h&gt;
<span class="lineNum">      11 </span>                :            : #include &quot;sflow_api.h&quot;
<span class="lineNum">      12 </span>                :            : 
<span class="lineNum">      13 </span>                :            : static void resetSampleCollector(SFLReceiver *receiver);
<span class="lineNum">      14 </span>                :            : static void sendSample(SFLReceiver *receiver);
<span class="lineNum">      15 </span>                :            : static void sflError(SFLReceiver *receiver, char *errm);
<span class="lineNum">      16 </span>                :            : inline static void putNet32(SFLReceiver *receiver, u_int32_t val);
<span class="lineNum">      17 </span>                :            : inline static void putAddress(SFLReceiver *receiver, SFLAddress *addr);
<span class="lineNum">      18 </span>                :            : #ifdef SFLOW_DO_SOCKET
<span class="lineNum">      19 </span>                :            : static void initSocket(SFLReceiver *receiver);
<span class="lineNum">      20 </span>                :            : #endif
<span class="lineNum">      21 </span>                :            : 
<span class="lineNum">      22 </span>                :            : /*_________________--------------------------__________________
<span class="lineNum">      23 </span>                :            :   _________________    sfl_receiver_init     __________________
<span class="lineNum">      24 </span>                :            :   -----------------__________________________------------------
<a name="25"><span class="lineNum">      25 </span>                :            : */</a>
<span class="lineNum">      26 </span>                :            : 
<span class="lineNum">      27 </span>                :<span class="lineCov">          6 : void sfl_receiver_init(SFLReceiver *receiver, SFLAgent *agent)</span>
<span class="lineNum">      28 </span>                :            : {
<span class="lineNum">      29 </span>                :            :     /* first clear everything */
<span class="lineNum">      30 </span>                :<span class="lineCov">          6 :     memset(receiver, 0, sizeof(*receiver));</span>
<span class="lineNum">      31 </span>                :            : 
<span class="lineNum">      32 </span>                :            :     /* now copy in the parameters */
<span class="lineNum">      33 </span>                :<span class="lineCov">          6 :     receiver-&gt;agent = agent;</span>
<span class="lineNum">      34 </span>                :            : 
<span class="lineNum">      35 </span>                :            :     /* set defaults */
<span class="lineNum">      36 </span>                :<span class="lineCov">          6 :     receiver-&gt;sFlowRcvrMaximumDatagramSize = SFL_DEFAULT_DATAGRAM_SIZE;</span>
<span class="lineNum">      37 </span>                :<span class="lineCov">          6 :     receiver-&gt;sFlowRcvrPort = SFL_DEFAULT_COLLECTOR_PORT;</span>
<span class="lineNum">      38 </span>                :            : 
<span class="lineNum">      39 </span>                :            : #ifdef SFLOW_DO_SOCKET
<span class="lineNum">      40 </span>                :            :     /* initialize the socket address */
<span class="lineNum">      41 </span>                :            :     initSocket(receiver);
<span class="lineNum">      42 </span>                :            : #endif
<span class="lineNum">      43 </span>                :            : 
<span class="lineNum">      44 </span>                :            :     /* preset some of the header fields */
<span class="lineNum">      45 </span>                :<span class="lineCov">          6 :     receiver-&gt;sampleCollector.datap = receiver-&gt;sampleCollector.data;</span>
<span class="lineNum">      46 </span>                :<span class="lineCov">          6 :     putNet32(receiver, SFLDATAGRAM_VERSION5);</span>
<span class="lineNum">      47 </span>                :<span class="lineCov">          6 :     putAddress(receiver, &amp;agent-&gt;myIP);</span>
<span class="lineNum">      48 </span>                :<span class="lineCov">          6 :     putNet32(receiver, agent-&gt;subId);</span>
<span class="lineNum">      49 </span>                :            : 
<span class="lineNum">      50 </span>                :            :     /* prepare to receive the first sample */
<span class="lineNum">      51 </span>                :<span class="lineCov">          6 :     resetSampleCollector(receiver);</span>
<span class="lineNum">      52 </span>                :<span class="lineCov">          6 : }</span>
<span class="lineNum">      53 </span>                :            : 
<span class="lineNum">      54 </span>                :            : /*_________________---------------------------__________________
<span class="lineNum">      55 </span>                :            :   _________________      reset                __________________
<span class="lineNum">      56 </span>                :            :   -----------------___________________________------------------
<span class="lineNum">      57 </span>                :            : 
<span class="lineNum">      58 </span>                :            :   called on timeout, or when owner string is cleared
<a name="59"><span class="lineNum">      59 </span>                :            : */</a>
<span class="lineNum">      60 </span>                :            : 
<span class="lineNum">      61 </span>                :<span class="lineNoCov">          0 : static void reset(SFLReceiver *receiver) {</span>
<span class="lineNum">      62 </span>                :            :     // ask agent to tell samplers and pollers to stop sending samples
<span class="lineNum">      63 </span>                :<span class="lineNoCov">          0 :     sfl_agent_resetReceiver(receiver-&gt;agent, receiver);</span>
<span class="lineNum">      64 </span>                :            :     // reinitialize
<span class="lineNum">      65 </span>                :<span class="lineNoCov">          0 :     sfl_receiver_init(receiver, receiver-&gt;agent);</span>
<span class="lineNum">      66 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">      67 </span>                :            : 
<span class="lineNum">      68 </span>                :            : #ifdef SFLOW_DO_SOCKET
<span class="lineNum">      69 </span>                :            : /*_________________---------------------------__________________
<span class="lineNum">      70 </span>                :            :   _________________      initSocket           __________________
<span class="lineNum">      71 </span>                :            :   -----------------___________________________------------------
<span class="lineNum">      72 </span>                :            : */
<span class="lineNum">      73 </span>                :            : 
<span class="lineNum">      74 </span>                :            : static void initSocket(SFLReceiver *receiver) {
<span class="lineNum">      75 </span>                :            :     if(receiver-&gt;sFlowRcvrAddress.type == SFLADDRESSTYPE_IP_V6) {
<span class="lineNum">      76 </span>                :            :     struct sockaddr_in6 *sa6 = &amp;receiver-&gt;receiver6;
<span class="lineNum">      77 </span>                :            :     sa6-&gt;sin6_port = htons((u_int16_t)receiver-&gt;sFlowRcvrPort);
<span class="lineNum">      78 </span>                :            :     sa6-&gt;sin6_family = AF_INET6;
<span class="lineNum">      79 </span>                :            :     sa6-&gt;sin6_addr = receiver-&gt;sFlowRcvrAddress.address.ip_v6;
<span class="lineNum">      80 </span>                :            :     }
<span class="lineNum">      81 </span>                :            :     else {
<span class="lineNum">      82 </span>                :            :     struct sockaddr_in *sa4 = &amp;receiver-&gt;receiver4;
<span class="lineNum">      83 </span>                :            :     sa4-&gt;sin_port = htons((u_int16_t)receiver-&gt;sFlowRcvrPort);
<span class="lineNum">      84 </span>                :            :     sa4-&gt;sin_family = AF_INET;
<span class="lineNum">      85 </span>                :            :     sa4-&gt;sin_addr = receiver-&gt;sFlowRcvrAddress.address.ip_v4;
<span class="lineNum">      86 </span>                :            :     }
<span class="lineNum">      87 </span>                :            : }
<span class="lineNum">      88 </span>                :            : #endif
<span class="lineNum">      89 </span>                :            : 
<span class="lineNum">      90 </span>                :            : /*_________________----------------------------------------_____________
<span class="lineNum">      91 </span>                :            :   _________________          MIB Vars                      _____________
<span class="lineNum">      92 </span>                :            :   -----------------________________________________________-------------
<a name="93"><span class="lineNum">      93 </span>                :            : */</a>
<span class="lineNum">      94 </span>                :            : 
<span class="lineNum">      95 </span>                :<span class="lineNoCov">          0 : char * sfl_receiver_get_sFlowRcvrOwner(SFLReceiver *receiver) {</span>
<a name="96"><span class="lineNum">      96 </span>                :<span class="lineNoCov">          0 :     return receiver-&gt;sFlowRcvrOwner;</span></a>
<span class="lineNum">      97 </span>                :            : }
<span class="lineNum">      98 </span>                :<span class="lineCov">          6 : void sfl_receiver_set_sFlowRcvrOwner(SFLReceiver *receiver, char *sFlowRcvrOwner) {</span>
<span class="lineNum">      99 </span>                :<span class="lineCov">          6 :     receiver-&gt;sFlowRcvrOwner = sFlowRcvrOwner;</span>
<span class="lineNum">     100 </span>[<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 6 times"> + </span>]:<span class="lineCov">          6 :     if(sFlowRcvrOwner == NULL || sFlowRcvrOwner[0] == '\0') {</span>
<span class="lineNum">     101 </span>                :            :     // reset condition! owner string was cleared
<span class="lineNum">     102 </span>                :<span class="lineNoCov">          0 :     reset(receiver);</span>
<a name="103"><span class="lineNum">     103 </span>                :            :     }</a>
<span class="lineNum">     104 </span>                :<span class="lineCov">          6 : }</span>
<span class="lineNum">     105 </span>                :<span class="lineNoCov">          0 : time_t sfl_receiver_get_sFlowRcvrTimeout(SFLReceiver *receiver) {</span>
<a name="106"><span class="lineNum">     106 </span>                :<span class="lineNoCov">          0 :     return receiver-&gt;sFlowRcvrTimeout;</span></a>
<span class="lineNum">     107 </span>                :            : }
<span class="lineNum">     108 </span>                :<span class="lineCov">          6 : void sfl_receiver_set_sFlowRcvrTimeout(SFLReceiver *receiver, time_t sFlowRcvrTimeout) {</span>
<a name="109"><span class="lineNum">     109 </span>                :<span class="lineCov">          6 :     receiver-&gt;sFlowRcvrTimeout =sFlowRcvrTimeout;</span></a>
<span class="lineNum">     110 </span>                :<span class="lineCov">          6 : }</span>
<span class="lineNum">     111 </span>                :<span class="lineNoCov">          0 : u_int32_t sfl_receiver_get_sFlowRcvrMaximumDatagramSize(SFLReceiver *receiver) {</span>
<a name="112"><span class="lineNum">     112 </span>                :<span class="lineNoCov">          0 :     return receiver-&gt;sFlowRcvrMaximumDatagramSize;</span></a>
<span class="lineNum">     113 </span>                :            : }
<span class="lineNum">     114 </span>                :<span class="lineNoCov">          0 : void sfl_receiver_set_sFlowRcvrMaximumDatagramSize(SFLReceiver *receiver, u_int32_t sFlowRcvrMaximumDatagramSize) {</span>
<span class="lineNum">     115 </span>                :<span class="lineNoCov">          0 :     u_int32_t mdz = sFlowRcvrMaximumDatagramSize;</span>
<span class="lineNum">     116 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(mdz &lt; SFL_MIN_DATAGRAM_SIZE) mdz = SFL_MIN_DATAGRAM_SIZE;</span>
<a name="117"><span class="lineNum">     117 </span>                :<span class="lineNoCov">          0 :     receiver-&gt;sFlowRcvrMaximumDatagramSize = mdz;</span></a>
<span class="lineNum">     118 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     119 </span>                :<span class="lineNoCov">          0 : SFLAddress *sfl_receiver_get_sFlowRcvrAddress(SFLReceiver *receiver) {</span>
<a name="120"><span class="lineNum">     120 </span>                :<span class="lineNoCov">          0 :     return &amp;receiver-&gt;sFlowRcvrAddress;</span></a>
<span class="lineNum">     121 </span>                :            : }
<span class="lineNum">     122 </span>                :<span class="lineNoCov">          0 : void sfl_receiver_set_sFlowRcvrAddress(SFLReceiver *receiver, SFLAddress *sFlowRcvrAddress) {</span>
<span class="lineNum">     123 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(sFlowRcvrAddress) receiver-&gt;sFlowRcvrAddress = *sFlowRcvrAddress; // structure copy</span>
<span class="lineNum">     124 </span>                :            : #ifdef SFLOW_DO_SOCKET
<span class="lineNum">     125 </span>                :            :     initSocket(receiver);
<a name="126"><span class="lineNum">     126 </span>                :            : #endif</a>
<span class="lineNum">     127 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     128 </span>                :<span class="lineNoCov">          0 : u_int32_t sfl_receiver_get_sFlowRcvrPort(SFLReceiver *receiver) {</span>
<a name="129"><span class="lineNum">     129 </span>                :<span class="lineNoCov">          0 :     return receiver-&gt;sFlowRcvrPort;</span></a>
<span class="lineNum">     130 </span>                :            : }
<span class="lineNum">     131 </span>                :<span class="lineNoCov">          0 : void sfl_receiver_set_sFlowRcvrPort(SFLReceiver *receiver, u_int32_t sFlowRcvrPort) {</span>
<span class="lineNum">     132 </span>                :<span class="lineNoCov">          0 :     receiver-&gt;sFlowRcvrPort = sFlowRcvrPort;</span>
<span class="lineNum">     133 </span>                :            :     // update the socket structure
<span class="lineNum">     134 </span>                :            : #ifdef SFLOW_DO_SOCKET
<span class="lineNum">     135 </span>                :            :     initSocket(receiver);
<span class="lineNum">     136 </span>                :            : #endif
<span class="lineNum">     137 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     138 </span>                :            : 
<span class="lineNum">     139 </span>                :            : /*_________________---------------------------__________________
<span class="lineNum">     140 </span>                :            :   _________________   sfl_receiver_tick       __________________
<span class="lineNum">     141 </span>                :            :   -----------------___________________________------------------
<a name="142"><span class="lineNum">     142 </span>                :            : */</a>
<span class="lineNum">     143 </span>                :            : 
<span class="lineNum">     144 </span>                :<span class="lineCov">         15 : void sfl_receiver_tick(SFLReceiver *receiver, time_t now)</span>
<span class="lineNum">     145 </span>                :            : {
<span class="lineNum">     146 </span>                :            :     // if there are any samples to send, flush them now
<span class="lineNum">     147 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>]:<span class="lineCov">         15 :     if(receiver-&gt;sampleCollector.numSamples &gt; 0) sendSample(receiver);</span>
<span class="lineNum">     148 </span>                :            :     // check the timeout
<span class="lineNum">     149 </span>[<span class="branchCov" title="Branch 0 was taken 15 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 15 times"> + </span>]:<span class="lineCov">         15 :     if(receiver-&gt;sFlowRcvrTimeout &amp;&amp; (u_int32_t)receiver-&gt;sFlowRcvrTimeout != 0xFFFFFFFF) {</span>
<span class="lineNum">     150 </span>                :            :     // count down one tick and reset if we reach 0
<span class="lineNum">     151 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(--receiver-&gt;sFlowRcvrTimeout == 0) reset(receiver);</span>
<span class="lineNum">     152 </span>                :            :     }
<span class="lineNum">     153 </span>                :<span class="lineCov">         15 : }</span>
<span class="lineNum">     154 </span>                :            : 
<span class="lineNum">     155 </span>                :            : /*_________________-----------------------------__________________
<span class="lineNum">     156 </span>                :            :   _________________   receiver write utilities  __________________
<span class="lineNum">     157 </span>                :            :   -----------------_____________________________------------------
<a name="158"><span class="lineNum">     158 </span>                :            : */</a>
<span class="lineNum">     159 </span>                :            : 
<span class="lineNum">     160 </span>                :<span class="lineCov">         14 : inline static void put32(SFLReceiver *receiver, u_int32_t val)</span>
<span class="lineNum">     161 </span>                :            : {
<span class="lineNum">     162 </span>                :<span class="lineCov">         14 :     *receiver-&gt;sampleCollector.datap++ = val;</span>
<a name="163"><span class="lineNum">     163 </span>                :<span class="lineCov">         14 : }</span></a>
<span class="lineNum">     164 </span>                :            : 
<span class="lineNum">     165 </span>                :<span class="lineCov">        915 : inline static void putNet32(SFLReceiver *receiver, u_int32_t val)</span>
<span class="lineNum">     166 </span>                :            : {
<span class="lineNum">     167 </span>                :<span class="lineCov">        915 :     *receiver-&gt;sampleCollector.datap++ = htonl(val);</span>
<a name="168"><span class="lineNum">     168 </span>                :<span class="lineCov">        915 : }</span></a>
<span class="lineNum">     169 </span>                :            : 
<span class="lineNum">     170 </span>                :<span class="lineCov">          4 : inline static void putNet32_run(SFLReceiver *receiver, void *obj, size_t quads)</span>
<span class="lineNum">     171 </span>                :            : {
<span class="lineNum">     172 </span>                :<span class="lineCov">          4 :     u_int32_t *from = (u_int32_t *)obj;</span>
<span class="lineNum">     173 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchCov" title="Branch 2 was taken 4 times"> + </span>]:<span class="lineCov">          7 :     while(quads--) putNet32(receiver, *from++);</span>
<a name="174"><span class="lineNum">     174 </span>                :<span class="lineCov">          4 : }</span></a>
<span class="lineNum">     175 </span>                :            : 
<span class="lineNum">     176 </span>                :<span class="lineCov">         68 : inline static void putNet64(SFLReceiver *receiver, u_int64_t val64)</span>
<span class="lineNum">     177 </span>                :            : {
<span class="lineNum">     178 </span>                :<span class="lineCov">         68 :     u_int32_t *firstQuadPtr = receiver-&gt;sampleCollector.datap;</span>
<span class="lineNum">     179 </span>                :            :     // first copy the bytes in
<span class="lineNum">     180 </span>                :<span class="lineCov">         68 :     memcpy((u_char *)firstQuadPtr, &amp;val64, 8);</span>
<span class="lineNum">     181 </span>        [<span class="branchCov" title="Branch 1 was taken 68 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         68 :     if(htonl(1) != 1) {</span>
<span class="lineNum">     182 </span>                :            :     // swap the bytes, and reverse the quads too
<span class="lineNum">     183 </span>                :<span class="lineCov">         68 :     u_int32_t tmp = *receiver-&gt;sampleCollector.datap++;</span>
<span class="lineNum">     184 </span>                :<span class="lineCov">         68 :     *firstQuadPtr = htonl(*receiver-&gt;sampleCollector.datap);</span>
<span class="lineNum">     185 </span>                :<span class="lineCov">         68 :     *receiver-&gt;sampleCollector.datap++ = htonl(tmp);</span>
<span class="lineNum">     186 </span>                :            :     }
<span class="lineNum">     187 </span>                :<span class="lineNoCov">          0 :     else receiver-&gt;sampleCollector.datap += 2;</span>
<a name="188"><span class="lineNum">     188 </span>                :<span class="lineCov">         68 : }</span></a>
<span class="lineNum">     189 </span>                :            : 
<span class="lineNum">     190 </span>                :<span class="lineNoCov">          0 : inline static void put128(SFLReceiver *receiver, u_char *val)</span>
<span class="lineNum">     191 </span>                :            : {
<span class="lineNum">     192 </span>                :<span class="lineNoCov">          0 :     memcpy(receiver-&gt;sampleCollector.datap, val, 16);</span>
<span class="lineNum">     193 </span>                :<span class="lineNoCov">          0 :     receiver-&gt;sampleCollector.datap += 4;</span>
<a name="194"><span class="lineNum">     194 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     195 </span>                :            : 
<span class="lineNum">     196 </span>                :<span class="lineCov">         14 : inline static void putString(SFLReceiver *receiver, SFLString *s)</span>
<span class="lineNum">     197 </span>                :            : {
<span class="lineNum">     198 </span>                :<span class="lineCov">         14 :     putNet32(receiver, s-&gt;len);</span>
<span class="lineNum">     199 </span>                :<span class="lineCov">         14 :     memcpy(receiver-&gt;sampleCollector.datap, s-&gt;str, s-&gt;len);</span>
<span class="lineNum">     200 </span>                :<span class="lineCov">         14 :     receiver-&gt;sampleCollector.datap += (s-&gt;len + 3) / 4; /* pad to 4-byte boundary */</span>
<span class="lineNum">     201 </span>        [<span class="branchCov" title="Branch 0 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         14 :     if ((s-&gt;len % 4) != 0){</span>
<span class="lineNum">     202 </span>                :<span class="lineCov">         14 :         u_int8_t padding = 4 - (s-&gt;len % 4);</span>
<span class="lineNum">     203 </span>                :<span class="lineCov">         14 :         memset(((u_int8_t*)receiver-&gt;sampleCollector.datap)-padding, 0, padding);</span>
<span class="lineNum">     204 </span>                :            :     }
<a name="205"><span class="lineNum">     205 </span>                :<span class="lineCov">         14 : }</span></a>
<span class="lineNum">     206 </span>                :            : 
<span class="lineNum">     207 </span>                :<span class="lineCov">         14 : inline static u_int32_t stringEncodingLength(SFLString *s) {</span>
<span class="lineNum">     208 </span>                :            :     // answer in bytes,  so remember to mulitply by 4 after rounding up to nearest 4-byte boundary
<span class="lineNum">     209 </span>                :<span class="lineCov">         14 :     return 4 + (((s-&gt;len + 3) / 4) * 4);</span>
<a name="210"><span class="lineNum">     210 </span>                :            : }</a>
<span class="lineNum">     211 </span>                :            : 
<span class="lineNum">     212 </span>                :<span class="lineCov">          8 : inline static void putAddress(SFLReceiver *receiver, SFLAddress *addr)</span>
<span class="lineNum">     213 </span>                :            : {
<span class="lineNum">     214 </span>                :            :     // encode unspecified addresses as IPV4:0.0.0.0 - or should we flag this as an error?
<span class="lineNum">     215 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>]:<span class="lineCov">          8 :     if(addr-&gt;type == 0) {</span>
<span class="lineNum">     216 </span>                :<span class="lineCov">          2 :     putNet32(receiver, SFLADDRESSTYPE_IP_V4);</span>
<span class="lineNum">     217 </span>                :<span class="lineCov">          2 :     put32(receiver, 0);</span>
<span class="lineNum">     218 </span>                :            :     }
<span class="lineNum">     219 </span>                :            :     else {
<span class="lineNum">     220 </span>                :<span class="lineCov">          6 :     putNet32(receiver, addr-&gt;type);</span>
<span class="lineNum">     221 </span>        [<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          6 :     if(addr-&gt;type == SFLADDRESSTYPE_IP_V4) put32(receiver, addr-&gt;address.ip_v4.addr);</span>
<span class="lineNum">     222 </span>                :<span class="lineNoCov">          0 :     else put128(receiver, addr-&gt;address.ip_v6.addr);</span>
<span class="lineNum">     223 </span>                :            :     }
<a name="224"><span class="lineNum">     224 </span>                :<span class="lineCov">          8 : }</span></a>
<span class="lineNum">     225 </span>                :            : 
<span class="lineNum">     226 </span>                :<span class="lineCov">          2 : inline static u_int32_t addressEncodingLength(SFLAddress *addr) {</span>
<span class="lineNum">     227 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          2 :     return (addr-&gt;type == SFLADDRESSTYPE_IP_V6) ? 20 : 8;  // type + address (unspecified == IPV4)</span>
<a name="228"><span class="lineNum">     228 </span>                :            : }</a>
<span class="lineNum">     229 </span>                :            : 
<span class="lineNum">     230 </span>                :<span class="lineCov">          4 : inline static void putMACAddress(SFLReceiver *receiver,</span>
<span class="lineNum">     231 </span>                :            :                                  const struct eth_addr mac)
<span class="lineNum">     232 </span>                :            : {
<span class="lineNum">     233 </span>                :<span class="lineCov">          4 :     memcpy(receiver-&gt;sampleCollector.datap, &amp;mac, 6);</span>
<span class="lineNum">     234 </span>                :<span class="lineCov">          4 :     receiver-&gt;sampleCollector.datap += 2;</span>
<a name="235"><span class="lineNum">     235 </span>                :<span class="lineCov">          4 : }</span></a>
<span class="lineNum">     236 </span>                :            : 
<span class="lineNum">     237 </span>                :<span class="lineCov">         14 : inline static void putSwitch(SFLReceiver *receiver, SFLExtended_switch *sw)</span>
<span class="lineNum">     238 </span>                :            : {
<span class="lineNum">     239 </span>                :<span class="lineCov">         14 :     putNet32(receiver, sw-&gt;src_vlan);</span>
<span class="lineNum">     240 </span>                :<span class="lineCov">         14 :     putNet32(receiver, sw-&gt;src_priority);</span>
<span class="lineNum">     241 </span>                :<span class="lineCov">         14 :     putNet32(receiver, sw-&gt;dst_vlan);</span>
<span class="lineNum">     242 </span>                :<span class="lineCov">         14 :     putNet32(receiver, sw-&gt;dst_priority);</span>
<a name="243"><span class="lineNum">     243 </span>                :<span class="lineCov">         14 : }</span></a>
<span class="lineNum">     244 </span>                :            : 
<span class="lineNum">     245 </span>                :<span class="lineNoCov">          0 : inline static void putRouter(SFLReceiver *receiver, SFLExtended_router *router)</span>
<span class="lineNum">     246 </span>                :            : {
<span class="lineNum">     247 </span>                :<span class="lineNoCov">          0 :     putAddress(receiver, &amp;router-&gt;nexthop);</span>
<span class="lineNum">     248 </span>                :<span class="lineNoCov">          0 :     putNet32(receiver, router-&gt;src_mask);</span>
<span class="lineNum">     249 </span>                :<span class="lineNoCov">          0 :     putNet32(receiver, router-&gt;dst_mask);</span>
<a name="250"><span class="lineNum">     250 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     251 </span>                :            : 
<span class="lineNum">     252 </span>                :<span class="lineNoCov">          0 : inline static u_int32_t routerEncodingLength(SFLExtended_router *router) {</span>
<span class="lineNum">     253 </span>                :<span class="lineNoCov">          0 :     return addressEncodingLength(&amp;router-&gt;nexthop) + 8;</span>
<a name="254"><span class="lineNum">     254 </span>                :            : }</a>
<span class="lineNum">     255 </span>                :            : 
<span class="lineNum">     256 </span>                :<span class="lineNoCov">          0 : inline static void putGateway(SFLReceiver *receiver, SFLExtended_gateway *gw)</span>
<span class="lineNum">     257 </span>                :            : {
<span class="lineNum">     258 </span>                :<span class="lineNoCov">          0 :     putAddress(receiver, &amp;gw-&gt;nexthop);</span>
<span class="lineNum">     259 </span>                :<span class="lineNoCov">          0 :     putNet32(receiver, gw-&gt;as);</span>
<span class="lineNum">     260 </span>                :<span class="lineNoCov">          0 :     putNet32(receiver, gw-&gt;src_as);</span>
<span class="lineNum">     261 </span>                :<span class="lineNoCov">          0 :     putNet32(receiver, gw-&gt;src_peer_as);</span>
<span class="lineNum">     262 </span>                :<span class="lineNoCov">          0 :     putNet32(receiver, gw-&gt;dst_as_path_segments);</span>
<span class="lineNum">     263 </span>                :            :     {
<span class="lineNum">     264 </span>                :<span class="lineNoCov">          0 :     u_int32_t seg = 0;</span>
<span class="lineNum">     265 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for(; seg &lt; gw-&gt;dst_as_path_segments; seg++) {</span>
<span class="lineNum">     266 </span>                :<span class="lineNoCov">          0 :         putNet32(receiver, gw-&gt;dst_as_path[seg].type);</span>
<span class="lineNum">     267 </span>                :<span class="lineNoCov">          0 :         putNet32(receiver, gw-&gt;dst_as_path[seg].length);</span>
<span class="lineNum">     268 </span>                :<span class="lineNoCov">          0 :         putNet32_run(receiver, gw-&gt;dst_as_path[seg].as.seq, gw-&gt;dst_as_path[seg].length);</span>
<span class="lineNum">     269 </span>                :            :     }
<span class="lineNum">     270 </span>                :            :     }
<span class="lineNum">     271 </span>                :<span class="lineNoCov">          0 :     putNet32(receiver, gw-&gt;communities_length);</span>
<span class="lineNum">     272 </span>                :<span class="lineNoCov">          0 :     putNet32_run(receiver, gw-&gt;communities, gw-&gt;communities_length);</span>
<span class="lineNum">     273 </span>                :<span class="lineNoCov">          0 :     putNet32(receiver, gw-&gt;localpref);</span>
<a name="274"><span class="lineNum">     274 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     275 </span>                :            : 
<span class="lineNum">     276 </span>                :<span class="lineNoCov">          0 : inline static u_int32_t gatewayEncodingLength(SFLExtended_gateway *gw) {</span>
<span class="lineNum">     277 </span>                :<span class="lineNoCov">          0 :     u_int32_t elemSiz = addressEncodingLength(&amp;gw-&gt;nexthop);</span>
<span class="lineNum">     278 </span>                :<span class="lineNoCov">          0 :     u_int32_t seg = 0;</span>
<span class="lineNum">     279 </span>                :<span class="lineNoCov">          0 :     elemSiz += 16; // as, src_as, src_peer_as, dst_as_path_segments</span>
<span class="lineNum">     280 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for(; seg &lt; gw-&gt;dst_as_path_segments; seg++) {</span>
<span class="lineNum">     281 </span>                :<span class="lineNoCov">          0 :     elemSiz += 8; // type, length</span>
<span class="lineNum">     282 </span>                :<span class="lineNoCov">          0 :     elemSiz += 4 * gw-&gt;dst_as_path[seg].length; // set/seq bytes</span>
<span class="lineNum">     283 </span>                :            :     }
<span class="lineNum">     284 </span>                :<span class="lineNoCov">          0 :     elemSiz += 4; // communities_length</span>
<span class="lineNum">     285 </span>                :<span class="lineNoCov">          0 :     elemSiz += 4 * gw-&gt;communities_length; // communities</span>
<span class="lineNum">     286 </span>                :<span class="lineNoCov">          0 :     elemSiz += 4; // localpref</span>
<span class="lineNum">     287 </span>                :<span class="lineNoCov">          0 :     return elemSiz;</span>
<a name="288"><span class="lineNum">     288 </span>                :            : }</a>
<span class="lineNum">     289 </span>                :            : 
<span class="lineNum">     290 </span>                :<span class="lineNoCov">          0 : inline static void putUser(SFLReceiver *receiver, SFLExtended_user *user)</span>
<span class="lineNum">     291 </span>                :            : {
<span class="lineNum">     292 </span>                :<span class="lineNoCov">          0 :     putNet32(receiver, user-&gt;src_charset);</span>
<span class="lineNum">     293 </span>                :<span class="lineNoCov">          0 :     putString(receiver, &amp;user-&gt;src_user);</span>
<span class="lineNum">     294 </span>                :<span class="lineNoCov">          0 :     putNet32(receiver, user-&gt;dst_charset);</span>
<span class="lineNum">     295 </span>                :<span class="lineNoCov">          0 :     putString(receiver, &amp;user-&gt;dst_user);</span>
<a name="296"><span class="lineNum">     296 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     297 </span>                :            : 
<span class="lineNum">     298 </span>                :<span class="lineNoCov">          0 : inline static u_int32_t userEncodingLength(SFLExtended_user *user) {</span>
<span class="lineNum">     299 </span>                :<span class="lineNoCov">          0 :     return 4</span>
<span class="lineNum">     300 </span>                :<span class="lineNoCov">          0 :     + stringEncodingLength(&amp;user-&gt;src_user)</span>
<span class="lineNum">     301 </span>                :            :     + 4
<span class="lineNum">     302 </span>                :<span class="lineNoCov">          0 :     + stringEncodingLength(&amp;user-&gt;dst_user);</span>
<a name="303"><span class="lineNum">     303 </span>                :            : }</a>
<span class="lineNum">     304 </span>                :            : 
<span class="lineNum">     305 </span>                :<span class="lineNoCov">          0 : inline static void putUrl(SFLReceiver *receiver, SFLExtended_url *url)</span>
<span class="lineNum">     306 </span>                :            : {
<span class="lineNum">     307 </span>                :<span class="lineNoCov">          0 :     putNet32(receiver, url-&gt;direction);</span>
<span class="lineNum">     308 </span>                :<span class="lineNoCov">          0 :     putString(receiver, &amp;url-&gt;url);</span>
<span class="lineNum">     309 </span>                :<span class="lineNoCov">          0 :     putString(receiver, &amp;url-&gt;host);</span>
<a name="310"><span class="lineNum">     310 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     311 </span>                :            : 
<span class="lineNum">     312 </span>                :<span class="lineNoCov">          0 : inline static u_int32_t urlEncodingLength(SFLExtended_url *url) {</span>
<span class="lineNum">     313 </span>                :<span class="lineNoCov">          0 :     return 4</span>
<span class="lineNum">     314 </span>                :<span class="lineNoCov">          0 :     + stringEncodingLength(&amp;url-&gt;url)</span>
<span class="lineNum">     315 </span>                :<span class="lineNoCov">          0 :     + stringEncodingLength(&amp;url-&gt;host);</span>
<a name="316"><span class="lineNum">     316 </span>                :            : }</a>
<span class="lineNum">     317 </span>                :            : 
<span class="lineNum">     318 </span>                :<span class="lineCov">          4 : inline static void putLabelStack(SFLReceiver *receiver, SFLLabelStack *labelStack)</span>
<span class="lineNum">     319 </span>                :            : {
<span class="lineNum">     320 </span>                :<span class="lineCov">          4 :     putNet32(receiver, labelStack-&gt;depth);</span>
<span class="lineNum">     321 </span>                :<span class="lineCov">          4 :     putNet32_run(receiver, labelStack-&gt;stack, labelStack-&gt;depth);</span>
<a name="322"><span class="lineNum">     322 </span>                :<span class="lineCov">          4 : }</span></a>
<span class="lineNum">     323 </span>                :            : 
<span class="lineNum">     324 </span>                :<span class="lineCov">          4 : inline static u_int32_t labelStackEncodingLength(SFLLabelStack *labelStack) {</span>
<span class="lineNum">     325 </span>                :<span class="lineCov">          4 :     return 4 + (4 * labelStack-&gt;depth);</span>
<a name="326"><span class="lineNum">     326 </span>                :            : }</a>
<span class="lineNum">     327 </span>                :            : 
<span class="lineNum">     328 </span>                :<span class="lineCov">          2 : inline static void putMpls(SFLReceiver *receiver, SFLExtended_mpls *mpls)</span>
<span class="lineNum">     329 </span>                :            : {
<span class="lineNum">     330 </span>                :<span class="lineCov">          2 :     putAddress(receiver, &amp;mpls-&gt;nextHop);</span>
<span class="lineNum">     331 </span>                :<span class="lineCov">          2 :     putLabelStack(receiver, &amp;mpls-&gt;in_stack);</span>
<span class="lineNum">     332 </span>                :<span class="lineCov">          2 :     putLabelStack(receiver, &amp;mpls-&gt;out_stack);</span>
<a name="333"><span class="lineNum">     333 </span>                :<span class="lineCov">          2 : }</span></a>
<span class="lineNum">     334 </span>                :            : 
<span class="lineNum">     335 </span>                :<span class="lineCov">          2 : inline static u_int32_t mplsEncodingLength(SFLExtended_mpls *mpls) {</span>
<span class="lineNum">     336 </span>                :<span class="lineCov">          4 :     return addressEncodingLength(&amp;mpls-&gt;nextHop)</span>
<span class="lineNum">     337 </span>                :<span class="lineCov">          2 :     + labelStackEncodingLength(&amp;mpls-&gt;in_stack)</span>
<span class="lineNum">     338 </span>                :<span class="lineCov">          2 :     + labelStackEncodingLength(&amp;mpls-&gt;out_stack);</span>
<a name="339"><span class="lineNum">     339 </span>                :            : }</a>
<span class="lineNum">     340 </span>                :            : 
<span class="lineNum">     341 </span>                :<span class="lineNoCov">          0 : inline static void putNat(SFLReceiver *receiver, SFLExtended_nat *nat)</span>
<span class="lineNum">     342 </span>                :            : {
<span class="lineNum">     343 </span>                :<span class="lineNoCov">          0 :     putAddress(receiver, &amp;nat-&gt;src);</span>
<span class="lineNum">     344 </span>                :<span class="lineNoCov">          0 :     putAddress(receiver, &amp;nat-&gt;dst);</span>
<a name="345"><span class="lineNum">     345 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     346 </span>                :            : 
<span class="lineNum">     347 </span>                :<span class="lineNoCov">          0 : inline static u_int32_t natEncodingLength(SFLExtended_nat *nat) {</span>
<span class="lineNum">     348 </span>                :<span class="lineNoCov">          0 :     return addressEncodingLength(&amp;nat-&gt;src)</span>
<span class="lineNum">     349 </span>                :<span class="lineNoCov">          0 :     + addressEncodingLength(&amp;nat-&gt;dst);</span>
<a name="350"><span class="lineNum">     350 </span>                :            : }</a>
<span class="lineNum">     351 </span>                :            : 
<span class="lineNum">     352 </span>                :<span class="lineNoCov">          0 : inline static void putMplsTunnel(SFLReceiver *receiver, SFLExtended_mpls_tunnel *tunnel)</span>
<span class="lineNum">     353 </span>                :            : {
<span class="lineNum">     354 </span>                :<span class="lineNoCov">          0 :     putString(receiver, &amp;tunnel-&gt;tunnel_lsp_name);</span>
<span class="lineNum">     355 </span>                :<span class="lineNoCov">          0 :     putNet32(receiver, tunnel-&gt;tunnel_id);</span>
<span class="lineNum">     356 </span>                :<span class="lineNoCov">          0 :     putNet32(receiver, tunnel-&gt;tunnel_cos);</span>
<a name="357"><span class="lineNum">     357 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     358 </span>                :            : 
<span class="lineNum">     359 </span>                :<span class="lineNoCov">          0 : inline static u_int32_t mplsTunnelEncodingLength(SFLExtended_mpls_tunnel *tunnel) {</span>
<span class="lineNum">     360 </span>                :<span class="lineNoCov">          0 :     return stringEncodingLength(&amp;tunnel-&gt;tunnel_lsp_name) + 8;</span>
<a name="361"><span class="lineNum">     361 </span>                :            : }</a>
<span class="lineNum">     362 </span>                :            : 
<span class="lineNum">     363 </span>                :<span class="lineNoCov">          0 : inline static void putMplsVc(SFLReceiver *receiver, SFLExtended_mpls_vc *vc)</span>
<span class="lineNum">     364 </span>                :            : {
<span class="lineNum">     365 </span>                :<span class="lineNoCov">          0 :     putString(receiver, &amp;vc-&gt;vc_instance_name);</span>
<span class="lineNum">     366 </span>                :<span class="lineNoCov">          0 :     putNet32(receiver, vc-&gt;vll_vc_id);</span>
<span class="lineNum">     367 </span>                :<span class="lineNoCov">          0 :     putNet32(receiver, vc-&gt;vc_label_cos);</span>
<a name="368"><span class="lineNum">     368 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     369 </span>                :            : 
<span class="lineNum">     370 </span>                :<span class="lineNoCov">          0 : inline static u_int32_t mplsVcEncodingLength(SFLExtended_mpls_vc *vc) {</span>
<span class="lineNum">     371 </span>                :<span class="lineNoCov">          0 :     return stringEncodingLength( &amp;vc-&gt;vc_instance_name) + 8;</span>
<a name="372"><span class="lineNum">     372 </span>                :            : }</a>
<span class="lineNum">     373 </span>                :            : 
<span class="lineNum">     374 </span>                :<span class="lineNoCov">          0 : inline static void putMplsFtn(SFLReceiver *receiver, SFLExtended_mpls_FTN *ftn)</span>
<span class="lineNum">     375 </span>                :            : {
<span class="lineNum">     376 </span>                :<span class="lineNoCov">          0 :     putString(receiver, &amp;ftn-&gt;mplsFTNDescr);</span>
<span class="lineNum">     377 </span>                :<span class="lineNoCov">          0 :     putNet32(receiver, ftn-&gt;mplsFTNMask);</span>
<a name="378"><span class="lineNum">     378 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     379 </span>                :            : 
<span class="lineNum">     380 </span>                :<span class="lineNoCov">          0 : inline static u_int32_t mplsFtnEncodingLength(SFLExtended_mpls_FTN *ftn) {</span>
<span class="lineNum">     381 </span>                :<span class="lineNoCov">          0 :     return stringEncodingLength( &amp;ftn-&gt;mplsFTNDescr) + 4;</span>
<a name="382"><span class="lineNum">     382 </span>                :            : }</a>
<span class="lineNum">     383 </span>                :            : 
<span class="lineNum">     384 </span>                :<span class="lineNoCov">          0 : inline static void putMplsLdpFec(SFLReceiver *receiver, SFLExtended_mpls_LDP_FEC *ldpfec)</span>
<span class="lineNum">     385 </span>                :            : {
<span class="lineNum">     386 </span>                :<span class="lineNoCov">          0 :     putNet32(receiver, ldpfec-&gt;mplsFecAddrPrefixLength);</span>
<a name="387"><span class="lineNum">     387 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     388 </span>                :            : 
<span class="lineNum">     389 </span>                :<span class="lineNoCov">          0 : inline static u_int32_t mplsLdpFecEncodingLength(SFLExtended_mpls_LDP_FEC *ldpfec) {</span>
<span class="lineNum">     390 </span>                :<span class="lineNoCov">          0 :     return 4;</span>
<a name="391"><span class="lineNum">     391 </span>                :            : }</a>
<span class="lineNum">     392 </span>                :            : 
<span class="lineNum">     393 </span>                :<span class="lineNoCov">          0 : inline static void putVlanTunnel(SFLReceiver *receiver, SFLExtended_vlan_tunnel *vlanTunnel)</span>
<span class="lineNum">     394 </span>                :            : {
<span class="lineNum">     395 </span>                :<span class="lineNoCov">          0 :     putLabelStack(receiver, &amp;vlanTunnel-&gt;stack);</span>
<a name="396"><span class="lineNum">     396 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     397 </span>                :            : 
<span class="lineNum">     398 </span>                :<span class="lineNoCov">          0 : inline static u_int32_t vlanTunnelEncodingLength(SFLExtended_vlan_tunnel *vlanTunnel) {</span>
<span class="lineNum">     399 </span>                :<span class="lineNoCov">          0 :     return labelStackEncodingLength(&amp;vlanTunnel-&gt;stack);</span>
<span class="lineNum">     400 </span>                :            : }
<a name="401"><span class="lineNum">     401 </span>                :            : </a>
<span class="lineNum">     402 </span>                :            : 
<span class="lineNum">     403 </span>                :<span class="lineCov">         14 : inline static void putGenericCounters(SFLReceiver *receiver, SFLIf_counters *counters)</span>
<span class="lineNum">     404 </span>                :            : {
<span class="lineNum">     405 </span>                :<span class="lineCov">         14 :     putNet32(receiver, counters-&gt;ifIndex);</span>
<span class="lineNum">     406 </span>                :<span class="lineCov">         14 :     putNet32(receiver, counters-&gt;ifType);</span>
<span class="lineNum">     407 </span>                :<span class="lineCov">         14 :     putNet64(receiver, counters-&gt;ifSpeed);</span>
<span class="lineNum">     408 </span>                :<span class="lineCov">         14 :     putNet32(receiver, counters-&gt;ifDirection);</span>
<span class="lineNum">     409 </span>                :<span class="lineCov">         14 :     putNet32(receiver, counters-&gt;ifStatus);</span>
<span class="lineNum">     410 </span>                :<span class="lineCov">         14 :     putNet64(receiver, counters-&gt;ifInOctets);</span>
<span class="lineNum">     411 </span>                :<span class="lineCov">         14 :     putNet32(receiver, counters-&gt;ifInUcastPkts);</span>
<span class="lineNum">     412 </span>                :<span class="lineCov">         14 :     putNet32(receiver, counters-&gt;ifInMulticastPkts);</span>
<span class="lineNum">     413 </span>                :<span class="lineCov">         14 :     putNet32(receiver, counters-&gt;ifInBroadcastPkts);</span>
<span class="lineNum">     414 </span>                :<span class="lineCov">         14 :     putNet32(receiver, counters-&gt;ifInDiscards);</span>
<span class="lineNum">     415 </span>                :<span class="lineCov">         14 :     putNet32(receiver, counters-&gt;ifInErrors);</span>
<span class="lineNum">     416 </span>                :<span class="lineCov">         14 :     putNet32(receiver, counters-&gt;ifInUnknownProtos);</span>
<span class="lineNum">     417 </span>                :<span class="lineCov">         14 :     putNet64(receiver, counters-&gt;ifOutOctets);</span>
<span class="lineNum">     418 </span>                :<span class="lineCov">         14 :     putNet32(receiver, counters-&gt;ifOutUcastPkts);</span>
<span class="lineNum">     419 </span>                :<span class="lineCov">         14 :     putNet32(receiver, counters-&gt;ifOutMulticastPkts);</span>
<span class="lineNum">     420 </span>                :<span class="lineCov">         14 :     putNet32(receiver, counters-&gt;ifOutBroadcastPkts);</span>
<span class="lineNum">     421 </span>                :<span class="lineCov">         14 :     putNet32(receiver, counters-&gt;ifOutDiscards);</span>
<span class="lineNum">     422 </span>                :<span class="lineCov">         14 :     putNet32(receiver, counters-&gt;ifOutErrors);</span>
<span class="lineNum">     423 </span>                :<span class="lineCov">         14 :     putNet32(receiver, counters-&gt;ifPromiscuousMode);</span>
<span class="lineNum">     424 </span>                :<span class="lineCov">         14 : }</span>
<span class="lineNum">     425 </span>                :            : 
<span class="lineNum">     426 </span>                :            : 
<span class="lineNum">     427 </span>                :            : /*_________________-----------------------------__________________
<span class="lineNum">     428 </span>                :            :   _________________      computeFlowSampleSize  __________________
<span class="lineNum">     429 </span>                :            :   -----------------_____________________________------------------
<a name="430"><span class="lineNum">     430 </span>                :            : */</a>
<span class="lineNum">     431 </span>                :            : 
<span class="lineNum">     432 </span>                :<span class="lineCov">         14 : static int computeFlowSampleSize(SFLReceiver *receiver, SFL_FLOW_SAMPLE_TYPE *fs)</span>
<span class="lineNum">     433 </span>                :            : {
<span class="lineNum">     434 </span>                :<span class="lineCov">         14 :     SFLFlow_sample_element *elem = fs-&gt;elements;</span>
<span class="lineNum">     435 </span>                :            : #ifdef SFL_USE_32BIT_INDEX
<span class="lineNum">     436 </span>                :            :     u_int siz = 52; /* tag, length, sequence_number, ds_class, ds_index, sampling_rate,
<span class="lineNum">     437 </span>                :            :                sample_pool, drops, inputFormat, input, outputFormat, output, number of elements */
<span class="lineNum">     438 </span>                :            : #else
<span class="lineNum">     439 </span>                :<span class="lineCov">         14 :     u_int siz = 40; /* tag, length, sequence_number, source_id, sampling_rate,</span>
<span class="lineNum">     440 </span>                :            :                sample_pool, drops, input, output, number of elements */
<span class="lineNum">     441 </span>                :            : #endif
<span class="lineNum">     442 </span>                :            : 
<span class="lineNum">     443 </span>                :<span class="lineCov">         14 :     fs-&gt;num_elements = 0; /* we're going to count them again even if this was set by the client */</span>
<span class="lineNum">     444 </span>        [<span class="branchCov" title="Branch 0 was taken 34 times"> + </span><span class="branchCov" title="Branch 1 was taken 14 times"> + </span>]:<span class="lineCov">         48 :     for(; elem != NULL; elem = elem-&gt;nxt) {</span>
<span class="lineNum">     445 </span>                :<span class="lineCov">         34 :     u_int elemSiz = 0;</span>
<span class="lineNum">     446 </span>                :<span class="lineCov">         34 :     fs-&gt;num_elements++;</span>
<span class="lineNum">     447 </span>                :<span class="lineCov">         34 :     siz += 8; /* tag, length */</span>
<span class="lineNum">     448 </span>  [<span class="branchCov" title="Branch 0 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">         34 :     switch(elem-&gt;tag) {</span>
<span class="lineNum">         </span><span class="branchCov" title="Branch 4 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 9 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 10 was not taken"> - </span><span class="branchNoCov" title="Branch 11 was not taken"> - </span><span class="branchNoCov" title="Branch 12 was not taken"> - </span><span class="branchNoCov" title="Branch 13 was not taken"> - </span> 
<span class="lineNum">         </span>   <span class="branchNoCov" title="Branch 14 was not taken"> - </span><span class="branchNoCov" title="Branch 15 was not taken"> - </span><span class="branchCov" title="Branch 16 was taken 2 times"> + </span><span class="branchCov" title="Branch 17 was taken 2 times"> + </span> 
<span class="lineNum">         </span>            <span class="branchNoCov" title="Branch 18 was not taken"> - </span>]
<span class="lineNum">     449 </span>                :            :     case SFLFLOW_HEADER:
<span class="lineNum">     450 </span>                :<span class="lineCov">         14 :         elemSiz = 16; /* header_protocol, frame_length, stripped, header_length */</span>
<span class="lineNum">     451 </span>                :<span class="lineCov">         14 :         elemSiz += ((elem-&gt;flowType.header.header_length + 3) / 4) * 4; /* header, rounded up to nearest 4 bytes */</span>
<span class="lineNum">     452 </span>                :<span class="lineCov">         14 :         break;</span>
<span class="lineNum">     453 </span>                :<span class="lineNoCov">          0 :     case SFLFLOW_ETHERNET: elemSiz = sizeof(SFLSampled_ethernet); break;</span>
<span class="lineNum">     454 </span>                :<span class="lineNoCov">          0 :     case SFLFLOW_IPV4: elemSiz = sizeof(SFLSampled_ipv4); break;</span>
<span class="lineNum">     455 </span>                :<span class="lineNoCov">          0 :     case SFLFLOW_IPV6: elemSiz = sizeof(SFLSampled_ipv6); break;</span>
<span class="lineNum">     456 </span>                :<span class="lineCov">         14 :     case SFLFLOW_EX_SWITCH: elemSiz = sizeof(SFLExtended_switch); break;</span>
<span class="lineNum">     457 </span>                :<span class="lineNoCov">          0 :     case SFLFLOW_EX_ROUTER: elemSiz = routerEncodingLength(&amp;elem-&gt;flowType.router); break;</span>
<span class="lineNum">     458 </span>                :<span class="lineNoCov">          0 :     case SFLFLOW_EX_GATEWAY: elemSiz = gatewayEncodingLength(&amp;elem-&gt;flowType.gateway); break;</span>
<span class="lineNum">     459 </span>                :<span class="lineNoCov">          0 :     case SFLFLOW_EX_USER: elemSiz = userEncodingLength(&amp;elem-&gt;flowType.user); break;</span>
<span class="lineNum">     460 </span>                :<span class="lineNoCov">          0 :     case SFLFLOW_EX_URL: elemSiz = urlEncodingLength(&amp;elem-&gt;flowType.url); break;</span>
<span class="lineNum">     461 </span>                :<span class="lineCov">          2 :     case SFLFLOW_EX_MPLS: elemSiz = mplsEncodingLength(&amp;elem-&gt;flowType.mpls); break;</span>
<span class="lineNum">     462 </span>                :<span class="lineNoCov">          0 :     case SFLFLOW_EX_NAT: elemSiz = natEncodingLength(&amp;elem-&gt;flowType.nat); break;</span>
<span class="lineNum">     463 </span>                :<span class="lineNoCov">          0 :     case SFLFLOW_EX_MPLS_TUNNEL: elemSiz = mplsTunnelEncodingLength(&amp;elem-&gt;flowType.mpls_tunnel); break;</span>
<span class="lineNum">     464 </span>                :<span class="lineNoCov">          0 :     case SFLFLOW_EX_MPLS_VC: elemSiz = mplsVcEncodingLength(&amp;elem-&gt;flowType.mpls_vc); break;</span>
<span class="lineNum">     465 </span>                :<span class="lineNoCov">          0 :     case SFLFLOW_EX_MPLS_FTN: elemSiz = mplsFtnEncodingLength(&amp;elem-&gt;flowType.mpls_ftn); break;</span>
<span class="lineNum">     466 </span>                :<span class="lineNoCov">          0 :     case SFLFLOW_EX_MPLS_LDP_FEC: elemSiz = mplsLdpFecEncodingLength(&amp;elem-&gt;flowType.mpls_ldp_fec); break;</span>
<span class="lineNum">     467 </span>                :<span class="lineNoCov">          0 :     case SFLFLOW_EX_VLAN_TUNNEL: elemSiz = vlanTunnelEncodingLength(&amp;elem-&gt;flowType.vlan_tunnel); break;</span>
<span class="lineNum">     468 </span>                :            :     case SFLFLOW_EX_IPV4_TUNNEL_EGRESS:
<span class="lineNum">     469 </span>                :            :     case SFLFLOW_EX_IPV4_TUNNEL_INGRESS:
<span class="lineNum">     470 </span>                :<span class="lineCov">          2 :         elemSiz = sizeof(SFLSampled_ipv4);</span>
<span class="lineNum">     471 </span>                :<span class="lineCov">          2 :         break;</span>
<span class="lineNum">     472 </span>                :            :     case SFLFLOW_EX_VNI_EGRESS:
<span class="lineNum">     473 </span>                :            :     case SFLFLOW_EX_VNI_INGRESS:
<span class="lineNum">     474 </span>                :<span class="lineCov">          2 :         elemSiz = sizeof(SFLExtended_vni);</span>
<span class="lineNum">     475 </span>                :<span class="lineCov">          2 :         break;</span>
<span class="lineNum">     476 </span>                :            :     default:
<span class="lineNum">     477 </span>                :<span class="lineNoCov">          0 :         sflError(receiver, &quot;unexpected packet_data_tag&quot;);</span>
<span class="lineNum">     478 </span>                :<span class="lineNoCov">          0 :         return -1;</span>
<span class="lineNum">     479 </span>                :            :         break;
<span class="lineNum">     480 </span>                :            :     }
<span class="lineNum">     481 </span>                :            :     // cache the element size, and accumulate it into the overall FlowSample size
<span class="lineNum">     482 </span>                :<span class="lineCov">         34 :     elem-&gt;length = elemSiz;</span>
<span class="lineNum">     483 </span>                :<span class="lineCov">         34 :     siz += elemSiz;</span>
<span class="lineNum">     484 </span>                :            :     }
<span class="lineNum">     485 </span>                :            : 
<span class="lineNum">     486 </span>                :<span class="lineCov">         14 :     return siz;</span>
<span class="lineNum">     487 </span>                :            : }
<span class="lineNum">     488 </span>                :            : 
<span class="lineNum">     489 </span>                :            : /*_________________-------------------------------__________________
<span class="lineNum">     490 </span>                :            :   _________________ sfl_receiver_writeFlowSample  __________________
<span class="lineNum">     491 </span>                :            :   -----------------_______________________________------------------
<a name="492"><span class="lineNum">     492 </span>                :            : */</a>
<span class="lineNum">     493 </span>                :            : 
<span class="lineNum">     494 </span>                :<span class="lineCov">         14 : int sfl_receiver_writeFlowSample(SFLReceiver *receiver, SFL_FLOW_SAMPLE_TYPE *fs)</span>
<span class="lineNum">     495 </span>                :            : {
<span class="lineNum">     496 </span>                :            :     int packedSize;
<span class="lineNum">     497 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 14 times"> + </span>]:<span class="lineCov">         14 :     if(fs == NULL) return -1;</span>
<span class="lineNum">     498 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 14 times"> + </span>]:<span class="lineCov">         14 :     if((packedSize = computeFlowSampleSize(receiver, fs)) == -1) return -1;</span>
<span class="lineNum">     499 </span>                :            : 
<span class="lineNum">     500 </span>                :            :     // check in case this one sample alone is too big for the datagram
<span class="lineNum">     501 </span>                :            :     // in fact - if it is even half as big then we should ditch it. Very
<span class="lineNum">     502 </span>                :            :     // important to avoid overruning the packet buffer.
<span class="lineNum">     503 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 14 times"> + </span>]:<span class="lineCov">         14 :     if(packedSize &gt; (int)(receiver-&gt;sFlowRcvrMaximumDatagramSize / 2)) {</span>
<span class="lineNum">     504 </span>                :<span class="lineNoCov">          0 :     sflError(receiver, &quot;flow sample too big for datagram&quot;);</span>
<span class="lineNum">     505 </span>                :<span class="lineNoCov">          0 :     return -1;</span>
<span class="lineNum">     506 </span>                :            :     }
<span class="lineNum">     507 </span>                :            : 
<span class="lineNum">     508 </span>                :            :     // if the sample pkt is full enough so that this sample might put
<span class="lineNum">     509 </span>                :            :     // it over the limit, then we should send it now before going on.
<span class="lineNum">     510 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 14 times"> + </span>]:<span class="lineCov">         14 :     if((receiver-&gt;sampleCollector.pktlen + packedSize) &gt;= receiver-&gt;sFlowRcvrMaximumDatagramSize)</span>
<span class="lineNum">     511 </span>                :<span class="lineNoCov">          0 :     sendSample(receiver);</span>
<span class="lineNum">     512 </span>                :            : 
<span class="lineNum">     513 </span>                :<span class="lineCov">         14 :     receiver-&gt;sampleCollector.numSamples++;</span>
<span class="lineNum">     514 </span>                :            : 
<span class="lineNum">     515 </span>                :            : #ifdef SFL_USE_32BIT_INDEX
<span class="lineNum">     516 </span>                :            :     putNet32(receiver, SFLFLOW_SAMPLE_EXPANDED);
<span class="lineNum">     517 </span>                :            : #else
<span class="lineNum">     518 </span>                :<span class="lineCov">         14 :     putNet32(receiver, SFLFLOW_SAMPLE);</span>
<span class="lineNum">     519 </span>                :            : #endif
<span class="lineNum">     520 </span>                :            : 
<span class="lineNum">     521 </span>                :<span class="lineCov">         14 :     putNet32(receiver, packedSize - 8); // don't include tag and len</span>
<span class="lineNum">     522 </span>                :<span class="lineCov">         14 :     putNet32(receiver, fs-&gt;sequence_number);</span>
<span class="lineNum">     523 </span>                :            : 
<span class="lineNum">     524 </span>                :            : #ifdef SFL_USE_32BIT_INDEX
<span class="lineNum">     525 </span>                :            :     putNet32(receiver, fs-&gt;ds_class);
<span class="lineNum">     526 </span>                :            :     putNet32(receiver, fs-&gt;ds_index);
<span class="lineNum">     527 </span>                :            : #else
<span class="lineNum">     528 </span>                :<span class="lineCov">         14 :     putNet32(receiver, fs-&gt;source_id);</span>
<span class="lineNum">     529 </span>                :            : #endif
<span class="lineNum">     530 </span>                :            : 
<span class="lineNum">     531 </span>                :<span class="lineCov">         14 :     putNet32(receiver, fs-&gt;sampling_rate);</span>
<span class="lineNum">     532 </span>                :<span class="lineCov">         14 :     putNet32(receiver, fs-&gt;sample_pool);</span>
<span class="lineNum">     533 </span>                :<span class="lineCov">         14 :     putNet32(receiver, fs-&gt;drops);</span>
<span class="lineNum">     534 </span>                :            : 
<span class="lineNum">     535 </span>                :            : #ifdef SFL_USE_32BIT_INDEX
<span class="lineNum">     536 </span>                :            :     putNet32(receiver, fs-&gt;inputFormat);
<span class="lineNum">     537 </span>                :            :     putNet32(receiver, fs-&gt;input);
<span class="lineNum">     538 </span>                :            :     putNet32(receiver, fs-&gt;outputFormat);
<span class="lineNum">     539 </span>                :            :     putNet32(receiver, fs-&gt;output);
<span class="lineNum">     540 </span>                :            : #else
<span class="lineNum">     541 </span>                :<span class="lineCov">         14 :     putNet32(receiver, fs-&gt;input);</span>
<span class="lineNum">     542 </span>                :<span class="lineCov">         14 :     putNet32(receiver, fs-&gt;output);</span>
<span class="lineNum">     543 </span>                :            : #endif
<span class="lineNum">     544 </span>                :            : 
<span class="lineNum">     545 </span>                :<span class="lineCov">         14 :     putNet32(receiver, fs-&gt;num_elements);</span>
<span class="lineNum">     546 </span>                :            : 
<span class="lineNum">     547 </span>                :            :     {
<span class="lineNum">     548 </span>                :<span class="lineCov">         14 :     SFLFlow_sample_element *elem = fs-&gt;elements;</span>
<span class="lineNum">     549 </span>        [<span class="branchCov" title="Branch 0 was taken 34 times"> + </span><span class="branchCov" title="Branch 1 was taken 14 times"> + </span>]:<span class="lineCov">         48 :     for(; elem != NULL; elem = elem-&gt;nxt) {</span>
<span class="lineNum">     550 </span>                :            : 
<span class="lineNum">     551 </span>                :<span class="lineCov">         34 :         putNet32(receiver, elem-&gt;tag);</span>
<span class="lineNum">     552 </span>                :<span class="lineCov">         34 :         putNet32(receiver, elem-&gt;length); // length cached in computeFlowSampleSize()</span>
<span class="lineNum">     553 </span>                :            : 
<span class="lineNum">     554 </span>  [<span class="branchCov" title="Branch 0 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">         34 :         switch(elem-&gt;tag) {</span>
<span class="lineNum">         </span><span class="branchCov" title="Branch 4 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 9 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 10 was not taken"> - </span><span class="branchNoCov" title="Branch 11 was not taken"> - </span><span class="branchNoCov" title="Branch 12 was not taken"> - </span><span class="branchNoCov" title="Branch 13 was not taken"> - </span> 
<span class="lineNum">         </span>   <span class="branchNoCov" title="Branch 14 was not taken"> - </span><span class="branchNoCov" title="Branch 15 was not taken"> - </span><span class="branchCov" title="Branch 16 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 17 was not taken"> - </span>]
<span class="lineNum">     555 </span>                :            :         case SFLFLOW_HEADER:
<span class="lineNum">     556 </span>                :<span class="lineCov">         14 :         putNet32(receiver, elem-&gt;flowType.header.header_protocol);</span>
<span class="lineNum">     557 </span>                :<span class="lineCov">         14 :         putNet32(receiver, elem-&gt;flowType.header.frame_length);</span>
<span class="lineNum">     558 </span>                :<span class="lineCov">         14 :         putNet32(receiver, elem-&gt;flowType.header.stripped);</span>
<span class="lineNum">     559 </span>                :<span class="lineCov">         14 :         putNet32(receiver, elem-&gt;flowType.header.header_length);</span>
<span class="lineNum">     560 </span>                :            :         /* the header */
<span class="lineNum">     561 </span>                :<span class="lineCov">         14 :         memcpy(receiver-&gt;sampleCollector.datap, elem-&gt;flowType.header.header_bytes, elem-&gt;flowType.header.header_length);</span>
<span class="lineNum">     562 </span>                :            :         /* round up to multiple of 4 to preserve alignment */
<span class="lineNum">     563 </span>                :<span class="lineCov">         14 :         receiver-&gt;sampleCollector.datap += ((elem-&gt;flowType.header.header_length + 3) / 4);</span>
<span class="lineNum">     564 </span>                :<span class="lineCov">         14 :         break;</span>
<span class="lineNum">     565 </span>                :            :         case SFLFLOW_ETHERNET:
<span class="lineNum">     566 </span>                :<span class="lineNoCov">          0 :         putNet32(receiver, elem-&gt;flowType.ethernet.eth_len);</span>
<span class="lineNum">     567 </span>                :<span class="lineNoCov">          0 :         putMACAddress(receiver, elem-&gt;flowType.ethernet.src_mac);</span>
<span class="lineNum">     568 </span>                :<span class="lineNoCov">          0 :         putMACAddress(receiver, elem-&gt;flowType.ethernet.dst_mac);</span>
<span class="lineNum">     569 </span>                :<span class="lineNoCov">          0 :         putNet32(receiver, elem-&gt;flowType.ethernet.eth_type);</span>
<span class="lineNum">     570 </span>                :<span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     571 </span>                :            :         case SFLFLOW_IPV4:
<span class="lineNum">     572 </span>                :            :         case SFLFLOW_EX_IPV4_TUNNEL_EGRESS:
<span class="lineNum">     573 </span>                :            :         case SFLFLOW_EX_IPV4_TUNNEL_INGRESS:
<span class="lineNum">     574 </span>                :<span class="lineCov">          2 :         putNet32(receiver, elem-&gt;flowType.ipv4.length);</span>
<span class="lineNum">     575 </span>                :<span class="lineCov">          2 :         putNet32(receiver, elem-&gt;flowType.ipv4.protocol);</span>
<span class="lineNum">     576 </span>                :<span class="lineCov">          2 :         put32(receiver, elem-&gt;flowType.ipv4.src_ip.addr);</span>
<span class="lineNum">     577 </span>                :<span class="lineCov">          2 :         put32(receiver, elem-&gt;flowType.ipv4.dst_ip.addr);</span>
<span class="lineNum">     578 </span>                :<span class="lineCov">          2 :         putNet32(receiver, elem-&gt;flowType.ipv4.src_port);</span>
<span class="lineNum">     579 </span>                :<span class="lineCov">          2 :         putNet32(receiver, elem-&gt;flowType.ipv4.dst_port);</span>
<span class="lineNum">     580 </span>                :<span class="lineCov">          2 :         putNet32(receiver, elem-&gt;flowType.ipv4.tcp_flags);</span>
<span class="lineNum">     581 </span>                :<span class="lineCov">          2 :         putNet32(receiver, elem-&gt;flowType.ipv4.tos);</span>
<span class="lineNum">     582 </span>                :<span class="lineCov">          2 :         break;</span>
<span class="lineNum">     583 </span>                :            :         case SFLFLOW_IPV6:
<span class="lineNum">     584 </span>                :<span class="lineNoCov">          0 :         putNet32(receiver, elem-&gt;flowType.ipv6.length);</span>
<span class="lineNum">     585 </span>                :<span class="lineNoCov">          0 :         putNet32(receiver, elem-&gt;flowType.ipv6.protocol);</span>
<span class="lineNum">     586 </span>                :<span class="lineNoCov">          0 :         put128(receiver, elem-&gt;flowType.ipv6.src_ip.addr);</span>
<span class="lineNum">     587 </span>                :<span class="lineNoCov">          0 :         put128(receiver, elem-&gt;flowType.ipv6.dst_ip.addr);</span>
<span class="lineNum">     588 </span>                :<span class="lineNoCov">          0 :         putNet32(receiver, elem-&gt;flowType.ipv6.src_port);</span>
<span class="lineNum">     589 </span>                :<span class="lineNoCov">          0 :         putNet32(receiver, elem-&gt;flowType.ipv6.dst_port);</span>
<span class="lineNum">     590 </span>                :<span class="lineNoCov">          0 :         putNet32(receiver, elem-&gt;flowType.ipv6.tcp_flags);</span>
<span class="lineNum">     591 </span>                :<span class="lineNoCov">          0 :         putNet32(receiver, elem-&gt;flowType.ipv6.priority);</span>
<span class="lineNum">     592 </span>                :<span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     593 </span>                :<span class="lineCov">         14 :         case SFLFLOW_EX_SWITCH: putSwitch(receiver, &amp;elem-&gt;flowType.sw); break;</span>
<span class="lineNum">     594 </span>                :<span class="lineNoCov">          0 :         case SFLFLOW_EX_ROUTER: putRouter(receiver, &amp;elem-&gt;flowType.router); break;</span>
<span class="lineNum">     595 </span>                :<span class="lineNoCov">          0 :         case SFLFLOW_EX_GATEWAY: putGateway(receiver, &amp;elem-&gt;flowType.gateway); break;</span>
<span class="lineNum">     596 </span>                :<span class="lineNoCov">          0 :         case SFLFLOW_EX_USER: putUser(receiver, &amp;elem-&gt;flowType.user); break;</span>
<span class="lineNum">     597 </span>                :<span class="lineNoCov">          0 :         case SFLFLOW_EX_URL: putUrl(receiver, &amp;elem-&gt;flowType.url); break;</span>
<span class="lineNum">     598 </span>                :<span class="lineCov">          2 :         case SFLFLOW_EX_MPLS: putMpls(receiver, &amp;elem-&gt;flowType.mpls); break;</span>
<span class="lineNum">     599 </span>                :<span class="lineNoCov">          0 :         case SFLFLOW_EX_NAT: putNat(receiver, &amp;elem-&gt;flowType.nat); break;</span>
<span class="lineNum">     600 </span>                :<span class="lineNoCov">          0 :         case SFLFLOW_EX_MPLS_TUNNEL: putMplsTunnel(receiver, &amp;elem-&gt;flowType.mpls_tunnel); break;</span>
<span class="lineNum">     601 </span>                :<span class="lineNoCov">          0 :         case SFLFLOW_EX_MPLS_VC: putMplsVc(receiver, &amp;elem-&gt;flowType.mpls_vc); break;</span>
<span class="lineNum">     602 </span>                :<span class="lineNoCov">          0 :         case SFLFLOW_EX_MPLS_FTN: putMplsFtn(receiver, &amp;elem-&gt;flowType.mpls_ftn); break;</span>
<span class="lineNum">     603 </span>                :<span class="lineNoCov">          0 :         case SFLFLOW_EX_MPLS_LDP_FEC: putMplsLdpFec(receiver, &amp;elem-&gt;flowType.mpls_ldp_fec); break;</span>
<span class="lineNum">     604 </span>                :<span class="lineNoCov">          0 :         case SFLFLOW_EX_VLAN_TUNNEL: putVlanTunnel(receiver, &amp;elem-&gt;flowType.vlan_tunnel); break;</span>
<span class="lineNum">     605 </span>                :            :         case SFLFLOW_EX_VNI_EGRESS:
<span class="lineNum">     606 </span>                :            :         case SFLFLOW_EX_VNI_INGRESS:
<span class="lineNum">     607 </span>                :<span class="lineCov">          2 :         putNet32(receiver, elem-&gt;flowType.tunnel_vni.vni);</span>
<span class="lineNum">     608 </span>                :<span class="lineCov">          2 :         break;</span>
<span class="lineNum">     609 </span>                :            : 
<span class="lineNum">     610 </span>                :            :         default:
<span class="lineNum">     611 </span>                :<span class="lineNoCov">          0 :         sflError(receiver, &quot;unexpected packet_data_tag&quot;);</span>
<span class="lineNum">     612 </span>                :<span class="lineNoCov">          0 :         return -1;</span>
<span class="lineNum">     613 </span>                :            :         break;
<span class="lineNum">     614 </span>                :            :         }
<span class="lineNum">     615 </span>                :            :     }
<span class="lineNum">     616 </span>                :            :     }
<span class="lineNum">     617 </span>                :            : 
<span class="lineNum">     618 </span>                :            :     // sanity check
<span class="lineNum">     619 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 14 times"> + </span>]:<span class="lineCov">         14 :     assert(((u_char *)receiver-&gt;sampleCollector.datap</span>
<span class="lineNum">     620 </span>                :            :         - (u_char *)receiver-&gt;sampleCollector.data
<span class="lineNum">     621 </span>                :            :         - receiver-&gt;sampleCollector.pktlen)  == (u_int32_t)packedSize);
<span class="lineNum">     622 </span>                :            : 
<span class="lineNum">     623 </span>                :            :     // update the pktlen
<span class="lineNum">     624 </span>                :<span class="lineCov">         14 :     receiver-&gt;sampleCollector.pktlen = (u_char *)receiver-&gt;sampleCollector.datap - (u_char *)receiver-&gt;sampleCollector.data;</span>
<span class="lineNum">     625 </span>                :<span class="lineCov">         14 :     return packedSize;</span>
<span class="lineNum">     626 </span>                :            : }
<span class="lineNum">     627 </span>                :            : 
<span class="lineNum">     628 </span>                :            : /*_________________-----------------------------__________________
<span class="lineNum">     629 </span>                :            :   _________________ computeCountersSampleSize   __________________
<span class="lineNum">     630 </span>                :            :   -----------------_____________________________------------------
<a name="631"><span class="lineNum">     631 </span>                :            : */</a>
<span class="lineNum">     632 </span>                :            : 
<span class="lineNum">     633 </span>                :<span class="lineCov">         20 : static int computeCountersSampleSize(SFLReceiver *receiver, SFL_COUNTERS_SAMPLE_TYPE *cs)</span>
<span class="lineNum">     634 </span>                :            : {
<span class="lineNum">     635 </span>                :<span class="lineCov">         20 :     SFLCounters_sample_element *elem = cs-&gt;elements;</span>
<span class="lineNum">     636 </span>                :            : #ifdef SFL_USE_32BIT_INDEX
<span class="lineNum">     637 </span>                :            :     u_int siz = 24; /* tag, length, sequence_number, ds_class, ds_index, number of elements */
<span class="lineNum">     638 </span>                :            : #else
<span class="lineNum">     639 </span>                :<span class="lineCov">         20 :     u_int siz = 20; /* tag, length, sequence_number, source_id, number of elements */</span>
<span class="lineNum">     640 </span>                :            : #endif
<span class="lineNum">     641 </span>                :            : 
<span class="lineNum">     642 </span>                :<span class="lineCov">         20 :     cs-&gt;num_elements = 0; /* we're going to count them again even if this was set by the client */</span>
<span class="lineNum">     643 </span>        [<span class="branchCov" title="Branch 0 was taken 56 times"> + </span><span class="branchCov" title="Branch 1 was taken 20 times"> + </span>]:<span class="lineCov">         76 :     for(; elem != NULL; elem = elem-&gt;nxt) {</span>
<span class="lineNum">     644 </span>                :<span class="lineCov">         56 :     u_int elemSiz = 0;</span>
<span class="lineNum">     645 </span>                :<span class="lineCov">         56 :     cs-&gt;num_elements++;</span>
<span class="lineNum">     646 </span>                :<span class="lineCov">         56 :     siz += 8; /* tag, length */</span>
<span class="lineNum">     647 </span>  [<span class="branchCov" title="Branch 0 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">         56 :     switch(elem-&gt;tag) {</span>
<span class="lineNum">         </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 2 times"> + </span><span class="branchCov" title="Branch 6 was taken 14 times"> + </span><span class="branchCov" title="Branch 7 was taken 14 times"> + </span><span class="branchCov" title="Branch 8 was taken 6 times"> + </span> 
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 9 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 10 was not taken"> - </span>]
<span class="lineNum">     648 </span>                :<span class="lineCov">         14 :     case SFLCOUNTERS_GENERIC:  elemSiz = SFL_CTR_GENERIC_XDR_SIZE; break;</span>
<span class="lineNum">     649 </span>                :<span class="lineNoCov">          0 :     case SFLCOUNTERS_ETHERNET: elemSiz = SFL_CTR_ETHERNET_XDR_SIZE; break;</span>
<span class="lineNum">     650 </span>                :<span class="lineNoCov">          0 :     case SFLCOUNTERS_TOKENRING: elemSiz = sizeof(elem-&gt;counterBlock.tokenring); break;</span>
<span class="lineNum">     651 </span>                :<span class="lineNoCov">          0 :     case SFLCOUNTERS_VG: elemSiz = sizeof(elem-&gt;counterBlock.vg); break;</span>
<span class="lineNum">     652 </span>                :<span class="lineNoCov">          0 :     case SFLCOUNTERS_VLAN: elemSiz = sizeof(elem-&gt;counterBlock.vlan); break;</span>
<span class="lineNum">     653 </span>                :<span class="lineCov">          2 :     case SFLCOUNTERS_LACP: elemSiz = SFL_CTR_LACP_XDR_SIZE; break;</span>
<span class="lineNum">     654 </span>                :<span class="lineCov">         14 :     case SFLCOUNTERS_OPENFLOWPORT: elemSiz = SFL_CTR_OPENFLOWPORT_XDR_SIZE; break;</span>
<span class="lineNum">     655 </span>                :<span class="lineCov">         14 :     case SFLCOUNTERS_PORTNAME: elemSiz = stringEncodingLength(&amp;elem-&gt;counterBlock.portName.portName); break;</span>
<span class="lineNum">     656 </span>                :<span class="lineCov">          6 :     case SFLCOUNTERS_APP_RESOURCES: elemSiz = SFL_CTR_APP_RESOURCES_XDR_SIZE; break;</span>
<span class="lineNum">     657 </span>                :<span class="lineCov">          6 :     case SFLCOUNTERS_OVSDP: elemSiz = SFL_CTR_OVSDP_XDR_SIZE; break;</span>
<span class="lineNum">     658 </span>                :            :     default:
<span class="lineNum">     659 </span>                :<span class="lineNoCov">          0 :         sflError(receiver, &quot;unexpected counters_tag&quot;);</span>
<span class="lineNum">     660 </span>                :<span class="lineNoCov">          0 :         return -1;</span>
<span class="lineNum">     661 </span>                :            :         break;
<span class="lineNum">     662 </span>                :            :     }
<span class="lineNum">     663 </span>                :            :     // cache the element size, and accumulate it into the overall FlowSample size
<span class="lineNum">     664 </span>                :<span class="lineCov">         56 :     elem-&gt;length = elemSiz;</span>
<span class="lineNum">     665 </span>                :<span class="lineCov">         56 :     siz += elemSiz;</span>
<span class="lineNum">     666 </span>                :            :     }
<span class="lineNum">     667 </span>                :<span class="lineCov">         20 :     return siz;</span>
<span class="lineNum">     668 </span>                :            : }
<span class="lineNum">     669 </span>                :            : 
<span class="lineNum">     670 </span>                :            : /*_________________----------------------------------__________________
<span class="lineNum">     671 </span>                :            :   _________________ sfl_receiver_writeCountersSample __________________
<span class="lineNum">     672 </span>                :            :   -----------------__________________________________------------------
<a name="673"><span class="lineNum">     673 </span>                :            : */</a>
<span class="lineNum">     674 </span>                :            : 
<span class="lineNum">     675 </span>                :<span class="lineCov">         20 : int sfl_receiver_writeCountersSample(SFLReceiver *receiver, SFL_COUNTERS_SAMPLE_TYPE *cs)</span>
<span class="lineNum">     676 </span>                :            : {
<span class="lineNum">     677 </span>                :            :     int packedSize;
<span class="lineNum">     678 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 20 times"> + </span>]:<span class="lineCov">         20 :     if(cs == NULL) return -1;</span>
<span class="lineNum">     679 </span>                :            :     // if the sample pkt is full enough so that this sample might put
<span class="lineNum">     680 </span>                :            :     // it over the limit, then we should send it now.
<span class="lineNum">     681 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 20 times"> + </span>]:<span class="lineCov">         20 :     if((packedSize = computeCountersSampleSize(receiver, cs)) == -1) return -1;</span>
<span class="lineNum">     682 </span>                :            : 
<span class="lineNum">     683 </span>                :            :     // check in case this one sample alone is too big for the datagram
<span class="lineNum">     684 </span>                :            :     // in fact - if it is even half as big then we should ditch it. Very
<span class="lineNum">     685 </span>                :            :     // important to avoid overruning the packet buffer.
<span class="lineNum">     686 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 20 times"> + </span>]:<span class="lineCov">         20 :     if(packedSize &gt; (int)(receiver-&gt;sFlowRcvrMaximumDatagramSize / 2)) {</span>
<span class="lineNum">     687 </span>                :<span class="lineNoCov">          0 :     sflError(receiver, &quot;counters sample too big for datagram&quot;);</span>
<span class="lineNum">     688 </span>                :<span class="lineNoCov">          0 :     return -1;</span>
<span class="lineNum">     689 </span>                :            :     }
<span class="lineNum">     690 </span>                :            : 
<span class="lineNum">     691 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 20 times"> + </span>]:<span class="lineCov">         20 :     if((receiver-&gt;sampleCollector.pktlen + packedSize) &gt;= receiver-&gt;sFlowRcvrMaximumDatagramSize)</span>
<span class="lineNum">     692 </span>                :<span class="lineNoCov">          0 :     sendSample(receiver);</span>
<span class="lineNum">     693 </span>                :            : 
<span class="lineNum">     694 </span>                :<span class="lineCov">         20 :     receiver-&gt;sampleCollector.numSamples++;</span>
<span class="lineNum">     695 </span>                :            : 
<span class="lineNum">     696 </span>                :            : #ifdef SFL_USE_32BIT_INDEX
<span class="lineNum">     697 </span>                :            :     putNet32(receiver, SFLCOUNTERS_SAMPLE_EXPANDED);
<span class="lineNum">     698 </span>                :            : #else
<span class="lineNum">     699 </span>                :<span class="lineCov">         20 :     putNet32(receiver, SFLCOUNTERS_SAMPLE);</span>
<span class="lineNum">     700 </span>                :            : #endif
<span class="lineNum">     701 </span>                :            : 
<span class="lineNum">     702 </span>                :<span class="lineCov">         20 :     putNet32(receiver, packedSize - 8); // tag and length not included</span>
<span class="lineNum">     703 </span>                :<span class="lineCov">         20 :     putNet32(receiver, cs-&gt;sequence_number);</span>
<span class="lineNum">     704 </span>                :            : 
<span class="lineNum">     705 </span>                :            : #ifdef SFL_USE_32BIT_INDEX
<span class="lineNum">     706 </span>                :            :     putNet32(receiver, cs-&gt;ds_class);
<span class="lineNum">     707 </span>                :            :     putNet32(receiver, cs-&gt;ds_index);
<span class="lineNum">     708 </span>                :            : #else
<span class="lineNum">     709 </span>                :<span class="lineCov">         20 :     putNet32(receiver, cs-&gt;source_id);</span>
<span class="lineNum">     710 </span>                :            : #endif
<span class="lineNum">     711 </span>                :            : 
<span class="lineNum">     712 </span>                :<span class="lineCov">         20 :     putNet32(receiver, cs-&gt;num_elements);</span>
<span class="lineNum">     713 </span>                :            : 
<span class="lineNum">     714 </span>                :            :     {
<span class="lineNum">     715 </span>                :<span class="lineCov">         20 :     SFLCounters_sample_element *elem = cs-&gt;elements;</span>
<span class="lineNum">     716 </span>        [<span class="branchCov" title="Branch 0 was taken 56 times"> + </span><span class="branchCov" title="Branch 1 was taken 20 times"> + </span>]:<span class="lineCov">         76 :     for(; elem != NULL; elem = elem-&gt;nxt) {</span>
<span class="lineNum">     717 </span>                :            : 
<span class="lineNum">     718 </span>                :<span class="lineCov">         56 :         putNet32(receiver, elem-&gt;tag);</span>
<span class="lineNum">     719 </span>                :<span class="lineCov">         56 :         putNet32(receiver, elem-&gt;length); // length cached in computeCountersSampleSize()</span>
<span class="lineNum">     720 </span>                :            : 
<span class="lineNum">     721 </span>  [<span class="branchCov" title="Branch 0 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">         56 :         switch(elem-&gt;tag) {</span>
<span class="lineNum">         </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 2 times"> + </span><span class="branchCov" title="Branch 6 was taken 14 times"> + </span><span class="branchCov" title="Branch 7 was taken 14 times"> + </span><span class="branchCov" title="Branch 8 was taken 6 times"> + </span> 
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 9 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 10 was not taken"> - </span>]
<span class="lineNum">     722 </span>                :            :         case SFLCOUNTERS_GENERIC:
<span class="lineNum">     723 </span>                :<span class="lineCov">         14 :         putGenericCounters(receiver, &amp;(elem-&gt;counterBlock.generic));</span>
<span class="lineNum">     724 </span>                :<span class="lineCov">         14 :         break;</span>
<span class="lineNum">     725 </span>                :            :         case SFLCOUNTERS_ETHERNET:
<span class="lineNum">     726 </span>                :            :         // all these counters are 32-bit
<span class="lineNum">     727 </span>                :<span class="lineNoCov">          0 :         putNet32_run(receiver, &amp;elem-&gt;counterBlock.ethernet, sizeof(elem-&gt;counterBlock.ethernet) / 4);</span>
<span class="lineNum">     728 </span>                :<span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     729 </span>                :            :         case SFLCOUNTERS_TOKENRING:
<span class="lineNum">     730 </span>                :            :         // all these counters are 32-bit
<span class="lineNum">     731 </span>                :<span class="lineNoCov">          0 :         putNet32_run(receiver, &amp;elem-&gt;counterBlock.tokenring, sizeof(elem-&gt;counterBlock.tokenring) / 4);</span>
<span class="lineNum">     732 </span>                :<span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     733 </span>                :            :         case SFLCOUNTERS_VG:
<span class="lineNum">     734 </span>                :            :         // mixed sizes
<span class="lineNum">     735 </span>                :<span class="lineNoCov">          0 :         putNet32(receiver, elem-&gt;counterBlock.vg.dot12InHighPriorityFrames);</span>
<span class="lineNum">     736 </span>                :<span class="lineNoCov">          0 :         putNet64(receiver, elem-&gt;counterBlock.vg.dot12InHighPriorityOctets);</span>
<span class="lineNum">     737 </span>                :<span class="lineNoCov">          0 :         putNet32(receiver, elem-&gt;counterBlock.vg.dot12InNormPriorityFrames);</span>
<span class="lineNum">     738 </span>                :<span class="lineNoCov">          0 :         putNet64(receiver, elem-&gt;counterBlock.vg.dot12InNormPriorityOctets);</span>
<span class="lineNum">     739 </span>                :<span class="lineNoCov">          0 :         putNet32(receiver, elem-&gt;counterBlock.vg.dot12InIPMErrors);</span>
<span class="lineNum">     740 </span>                :<span class="lineNoCov">          0 :         putNet32(receiver, elem-&gt;counterBlock.vg.dot12InOversizeFrameErrors);</span>
<span class="lineNum">     741 </span>                :<span class="lineNoCov">          0 :         putNet32(receiver, elem-&gt;counterBlock.vg.dot12InDataErrors);</span>
<span class="lineNum">     742 </span>                :<span class="lineNoCov">          0 :         putNet32(receiver, elem-&gt;counterBlock.vg.dot12InNullAddressedFrames);</span>
<span class="lineNum">     743 </span>                :<span class="lineNoCov">          0 :         putNet32(receiver, elem-&gt;counterBlock.vg.dot12OutHighPriorityFrames);</span>
<span class="lineNum">     744 </span>                :<span class="lineNoCov">          0 :         putNet64(receiver, elem-&gt;counterBlock.vg.dot12OutHighPriorityOctets);</span>
<span class="lineNum">     745 </span>                :<span class="lineNoCov">          0 :         putNet32(receiver, elem-&gt;counterBlock.vg.dot12TransitionIntoTrainings);</span>
<span class="lineNum">     746 </span>                :<span class="lineNoCov">          0 :         putNet64(receiver, elem-&gt;counterBlock.vg.dot12HCInHighPriorityOctets);</span>
<span class="lineNum">     747 </span>                :<span class="lineNoCov">          0 :         putNet64(receiver, elem-&gt;counterBlock.vg.dot12HCInNormPriorityOctets);</span>
<span class="lineNum">     748 </span>                :<span class="lineNoCov">          0 :         putNet64(receiver, elem-&gt;counterBlock.vg.dot12HCOutHighPriorityOctets);</span>
<span class="lineNum">     749 </span>                :<span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     750 </span>                :            :         case SFLCOUNTERS_VLAN:
<span class="lineNum">     751 </span>                :            :         // mixed sizes
<span class="lineNum">     752 </span>                :<span class="lineNoCov">          0 :         putNet32(receiver, elem-&gt;counterBlock.vlan.vlan_id);</span>
<span class="lineNum">     753 </span>                :<span class="lineNoCov">          0 :         putNet64(receiver, elem-&gt;counterBlock.vlan.octets);</span>
<span class="lineNum">     754 </span>                :<span class="lineNoCov">          0 :         putNet32(receiver, elem-&gt;counterBlock.vlan.ucastPkts);</span>
<span class="lineNum">     755 </span>                :<span class="lineNoCov">          0 :         putNet32(receiver, elem-&gt;counterBlock.vlan.multicastPkts);</span>
<span class="lineNum">     756 </span>                :<span class="lineNoCov">          0 :         putNet32(receiver, elem-&gt;counterBlock.vlan.broadcastPkts);</span>
<span class="lineNum">     757 </span>                :<span class="lineNoCov">          0 :         putNet32(receiver, elem-&gt;counterBlock.vlan.discards);</span>
<span class="lineNum">     758 </span>                :<span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     759 </span>                :            :         case SFLCOUNTERS_LACP:
<span class="lineNum">     760 </span>                :<span class="lineCov">          2 :         putMACAddress(receiver, elem-&gt;counterBlock.lacp.actorSystemID);</span>
<span class="lineNum">     761 </span>                :<span class="lineCov">          2 :         putMACAddress(receiver, elem-&gt;counterBlock.lacp.partnerSystemID);</span>
<span class="lineNum">     762 </span>                :<span class="lineCov">          2 :         putNet32(receiver, elem-&gt;counterBlock.lacp.attachedAggID);</span>
<span class="lineNum">     763 </span>                :<span class="lineCov">          2 :         put32(receiver, elem-&gt;counterBlock.lacp.portState.all);</span>
<span class="lineNum">     764 </span>                :<span class="lineCov">          2 :         putNet32(receiver, elem-&gt;counterBlock.lacp.LACPDUsRx);</span>
<span class="lineNum">     765 </span>                :<span class="lineCov">          2 :         putNet32(receiver, elem-&gt;counterBlock.lacp.markerPDUsRx);</span>
<span class="lineNum">     766 </span>                :<span class="lineCov">          2 :         putNet32(receiver, elem-&gt;counterBlock.lacp.markerResponsePDUsRx);</span>
<span class="lineNum">     767 </span>                :<span class="lineCov">          2 :         putNet32(receiver, elem-&gt;counterBlock.lacp.unknownRx);</span>
<span class="lineNum">     768 </span>                :<span class="lineCov">          2 :         putNet32(receiver, elem-&gt;counterBlock.lacp.illegalRx);</span>
<span class="lineNum">     769 </span>                :<span class="lineCov">          2 :         putNet32(receiver, elem-&gt;counterBlock.lacp.LACPDUsTx);</span>
<span class="lineNum">     770 </span>                :<span class="lineCov">          2 :         putNet32(receiver, elem-&gt;counterBlock.lacp.markerPDUsTx);</span>
<span class="lineNum">     771 </span>                :<span class="lineCov">          2 :         putNet32(receiver, elem-&gt;counterBlock.lacp.markerResponsePDUsTx);</span>
<span class="lineNum">     772 </span>                :<span class="lineCov">          2 :         break;</span>
<span class="lineNum">     773 </span>                :            :         case SFLCOUNTERS_OPENFLOWPORT:
<span class="lineNum">     774 </span>                :<span class="lineCov">         14 :         putNet64(receiver, elem-&gt;counterBlock.ofPort.datapath_id);</span>
<span class="lineNum">     775 </span>                :<span class="lineCov">         14 :         putNet32(receiver, elem-&gt;counterBlock.ofPort.port_no);</span>
<span class="lineNum">     776 </span>                :<span class="lineCov">         14 :         break;</span>
<span class="lineNum">     777 </span>                :            :         case SFLCOUNTERS_PORTNAME:
<span class="lineNum">     778 </span>                :<span class="lineCov">         14 :         putString(receiver, &amp;elem-&gt;counterBlock.portName.portName);</span>
<span class="lineNum">     779 </span>                :<span class="lineCov">         14 :         break;</span>
<span class="lineNum">     780 </span>                :            :         case SFLCOUNTERS_APP_RESOURCES:
<span class="lineNum">     781 </span>                :<span class="lineCov">          6 :         putNet32(receiver, elem-&gt;counterBlock.appResources.user_time);</span>
<span class="lineNum">     782 </span>                :<span class="lineCov">          6 :         putNet32(receiver, elem-&gt;counterBlock.appResources.system_time);</span>
<span class="lineNum">     783 </span>                :<span class="lineCov">          6 :         putNet64(receiver, elem-&gt;counterBlock.appResources.mem_used);</span>
<span class="lineNum">     784 </span>                :<span class="lineCov">          6 :         putNet64(receiver, elem-&gt;counterBlock.appResources.mem_max);</span>
<span class="lineNum">     785 </span>                :<span class="lineCov">          6 :         putNet32(receiver, elem-&gt;counterBlock.appResources.fd_open);</span>
<span class="lineNum">     786 </span>                :<span class="lineCov">          6 :         putNet32(receiver, elem-&gt;counterBlock.appResources.fd_max);</span>
<span class="lineNum">     787 </span>                :<span class="lineCov">          6 :         putNet32(receiver, elem-&gt;counterBlock.appResources.conn_open);</span>
<span class="lineNum">     788 </span>                :<span class="lineCov">          6 :         putNet32(receiver, elem-&gt;counterBlock.appResources.conn_max);</span>
<span class="lineNum">     789 </span>                :<span class="lineCov">          6 :         break;</span>
<span class="lineNum">     790 </span>                :            :         case SFLCOUNTERS_OVSDP:
<span class="lineNum">     791 </span>                :<span class="lineCov">          6 :         putNet32(receiver, elem-&gt;counterBlock.ovsdp.n_hit);</span>
<span class="lineNum">     792 </span>                :<span class="lineCov">          6 :         putNet32(receiver, elem-&gt;counterBlock.ovsdp.n_missed);</span>
<span class="lineNum">     793 </span>                :<span class="lineCov">          6 :         putNet32(receiver, elem-&gt;counterBlock.ovsdp.n_lost);</span>
<span class="lineNum">     794 </span>                :<span class="lineCov">          6 :         putNet32(receiver, elem-&gt;counterBlock.ovsdp.n_mask_hit);</span>
<span class="lineNum">     795 </span>                :<span class="lineCov">          6 :         putNet32(receiver, elem-&gt;counterBlock.ovsdp.n_flows);</span>
<span class="lineNum">     796 </span>                :<span class="lineCov">          6 :         putNet32(receiver, elem-&gt;counterBlock.ovsdp.n_masks);</span>
<span class="lineNum">     797 </span>                :<span class="lineCov">          6 :         break;</span>
<span class="lineNum">     798 </span>                :            :         default:
<span class="lineNum">     799 </span>                :<span class="lineNoCov">          0 :         sflError(receiver, &quot;unexpected counters_tag&quot;);</span>
<span class="lineNum">     800 </span>                :<span class="lineNoCov">          0 :         return -1;</span>
<span class="lineNum">     801 </span>                :            :         break;
<span class="lineNum">     802 </span>                :            :         }
<span class="lineNum">     803 </span>                :            :     }
<span class="lineNum">     804 </span>                :            :     }
<span class="lineNum">     805 </span>                :            :     // sanity check
<span class="lineNum">     806 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 20 times"> + </span>]:<span class="lineCov">         20 :     assert(((u_char *)receiver-&gt;sampleCollector.datap</span>
<span class="lineNum">     807 </span>                :            :         - (u_char *)receiver-&gt;sampleCollector.data
<span class="lineNum">     808 </span>                :            :         - receiver-&gt;sampleCollector.pktlen)  == (u_int32_t)packedSize);
<span class="lineNum">     809 </span>                :            : 
<span class="lineNum">     810 </span>                :            :     // update the pktlen
<span class="lineNum">     811 </span>                :<span class="lineCov">         20 :     receiver-&gt;sampleCollector.pktlen = (u_char *)receiver-&gt;sampleCollector.datap - (u_char *)receiver-&gt;sampleCollector.data;</span>
<span class="lineNum">     812 </span>                :<span class="lineCov">         20 :     return packedSize;</span>
<span class="lineNum">     813 </span>                :            : }
<span class="lineNum">     814 </span>                :            : 
<span class="lineNum">     815 </span>                :            : /*_________________---------------------------------__________________
<span class="lineNum">     816 </span>                :            :   _________________ sfl_receiver_samplePacketsSent  __________________
<span class="lineNum">     817 </span>                :            :   -----------------_________________________________------------------
<a name="818"><span class="lineNum">     818 </span>                :            : */</a>
<span class="lineNum">     819 </span>                :            : 
<span class="lineNum">     820 </span>                :<span class="lineNoCov">          0 : u_int32_t sfl_receiver_samplePacketsSent(SFLReceiver *receiver)</span>
<span class="lineNum">     821 </span>                :            : {
<span class="lineNum">     822 </span>                :<span class="lineNoCov">          0 :     return receiver-&gt;sampleCollector.packetSeqNo;</span>
<span class="lineNum">     823 </span>                :            : }
<span class="lineNum">     824 </span>                :            : 
<span class="lineNum">     825 </span>                :            : /*_________________---------------------------__________________
<span class="lineNum">     826 </span>                :            :   _________________     sendSample            __________________
<span class="lineNum">     827 </span>                :            :   -----------------___________________________------------------
<a name="828"><span class="lineNum">     828 </span>                :            : */</a>
<span class="lineNum">     829 </span>                :            : 
<span class="lineNum">     830 </span>                :<span class="lineCov">          9 : static void sendSample(SFLReceiver *receiver)</span>
<span class="lineNum">     831 </span>                :            : {
<span class="lineNum">     832 </span>                :            :     /* construct and send out the sample, then reset for the next one... */
<span class="lineNum">     833 </span>                :            :     /* first fill in the header with the latest values */
<span class="lineNum">     834 </span>                :            :     /* version, agent_address and sub_agent_id were pre-set. */
<span class="lineNum">     835 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 9 times"> + </span>]:<span class="lineCov">          9 :     u_int32_t hdrIdx = (receiver-&gt;agent-&gt;myIP.type == SFLADDRESSTYPE_IP_V6) ? 7 : 4;</span>
<span class="lineNum">     836 </span>                :<span class="lineCov">          9 :     receiver-&gt;sampleCollector.data[hdrIdx++] = htonl(++receiver-&gt;sampleCollector.packetSeqNo); /* seq no */</span>
<span class="lineNum">     837 </span>                :<span class="lineCov">          9 :     receiver-&gt;sampleCollector.data[hdrIdx++] = htonl((receiver-&gt;agent-&gt;now - receiver-&gt;agent-&gt;bootTime) * 1000); /* uptime */</span>
<span class="lineNum">     838 </span>                :<span class="lineCov">          9 :     receiver-&gt;sampleCollector.data[hdrIdx++] = htonl(receiver-&gt;sampleCollector.numSamples); /* num samples */</span>
<span class="lineNum">     839 </span>                :            :     /* send */
<span class="lineNum">     840 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          9 :     if(receiver-&gt;agent-&gt;sendFn) (*receiver-&gt;agent-&gt;sendFn)(receiver-&gt;agent-&gt;magic,</span>
<span class="lineNum">     841 </span>                :            :                                receiver-&gt;agent,
<span class="lineNum">     842 </span>                :            :                                receiver,
<span class="lineNum">     843 </span>                :<span class="lineCov">          9 :                                (u_char *)receiver-&gt;sampleCollector.data,</span>
<span class="lineNum">     844 </span>                :            :                                receiver-&gt;sampleCollector.pktlen);
<span class="lineNum">     845 </span>                :            :     else {
<span class="lineNum">     846 </span>                :            : #ifdef SFLOW_DO_SOCKET
<span class="lineNum">     847 </span>                :            :     /* send it myself */
<span class="lineNum">     848 </span>                :            :     if (receiver-&gt;sFlowRcvrAddress.type == SFLADDRESSTYPE_IP_V6) {
<span class="lineNum">     849 </span>                :            :         u_int32_t soclen = sizeof(struct sockaddr_in6);
<span class="lineNum">     850 </span>                :            :         int result = sendto(receiver-&gt;agent-&gt;receiverSocket6,
<span class="lineNum">     851 </span>                :            :                 receiver-&gt;sampleCollector.data,
<span class="lineNum">     852 </span>                :            :                 receiver-&gt;sampleCollector.pktlen,
<span class="lineNum">     853 </span>                :            :                 0,
<span class="lineNum">     854 </span>                :            :                 (struct sockaddr *)&amp;receiver-&gt;receiver6,
<span class="lineNum">     855 </span>                :            :                 soclen);
<span class="lineNum">     856 </span>                :            :         if(result == -1 &amp;&amp; errno != EINTR) sfl_agent_sysError(receiver-&gt;agent, &quot;receiver&quot;, &quot;IPv6 socket sendto error&quot;);
<span class="lineNum">     857 </span>                :            :         if(result == 0) sfl_agent_error(receiver-&gt;agent, &quot;receiver&quot;, &quot;IPv6 socket sendto returned 0&quot;);
<span class="lineNum">     858 </span>                :            :     }
<span class="lineNum">     859 </span>                :            :     else {
<span class="lineNum">     860 </span>                :            :         u_int32_t soclen = sizeof(struct sockaddr_in);
<span class="lineNum">     861 </span>                :            :         int result = sendto(receiver-&gt;agent-&gt;receiverSocket4,
<span class="lineNum">     862 </span>                :            :                 receiver-&gt;sampleCollector.data,
<span class="lineNum">     863 </span>                :            :                 receiver-&gt;sampleCollector.pktlen,
<span class="lineNum">     864 </span>                :            :                 0,
<span class="lineNum">     865 </span>                :            :                 (struct sockaddr *)&amp;receiver-&gt;receiver4,
<span class="lineNum">     866 </span>                :            :                 soclen);
<span class="lineNum">     867 </span>                :            :         if(result == -1 &amp;&amp; errno != EINTR) sfl_agent_sysError(receiver-&gt;agent, &quot;receiver&quot;, &quot;socket sendto error&quot;);
<span class="lineNum">     868 </span>                :            :         if(result == 0) sfl_agent_error(receiver-&gt;agent, &quot;receiver&quot;, &quot;socket sendto returned 0&quot;);
<span class="lineNum">     869 </span>                :            :     }
<span class="lineNum">     870 </span>                :            : #endif
<span class="lineNum">     871 </span>                :            :     }
<span class="lineNum">     872 </span>                :            : 
<span class="lineNum">     873 </span>                :            :     /* reset for the next time */
<span class="lineNum">     874 </span>                :<span class="lineCov">          9 :     resetSampleCollector(receiver);</span>
<span class="lineNum">     875 </span>                :<span class="lineCov">          9 : }</span>
<span class="lineNum">     876 </span>                :            : 
<span class="lineNum">     877 </span>                :            : /*_________________---------------------------__________________
<span class="lineNum">     878 </span>                :            :   _________________   resetSampleCollector    __________________
<span class="lineNum">     879 </span>                :            :   -----------------___________________________------------------
<a name="880"><span class="lineNum">     880 </span>                :            : */</a>
<span class="lineNum">     881 </span>                :            : 
<span class="lineNum">     882 </span>                :<span class="lineCov">         15 : static void resetSampleCollector(SFLReceiver *receiver)</span>
<span class="lineNum">     883 </span>                :            : {
<span class="lineNum">     884 </span>                :<span class="lineCov">         15 :     receiver-&gt;sampleCollector.pktlen = 0;</span>
<span class="lineNum">     885 </span>                :<span class="lineCov">         15 :     receiver-&gt;sampleCollector.numSamples = 0;</span>
<span class="lineNum">     886 </span>                :            :     /* point the datap to just after the header */
<span class="lineNum">     887 </span>                :<span class="lineCov">         30 :     receiver-&gt;sampleCollector.datap = (receiver-&gt;agent-&gt;myIP.type == SFLADDRESSTYPE_IP_V6) ?</span>
<span class="lineNum">     888 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 15 times"> + </span>]:<span class="lineCov">         15 :     (receiver-&gt;sampleCollector.data + 10) :  (receiver-&gt;sampleCollector.data + 7);</span>
<span class="lineNum">     889 </span>                :            : 
<span class="lineNum">     890 </span>                :<span class="lineCov">         15 :     receiver-&gt;sampleCollector.pktlen = (u_char *)receiver-&gt;sampleCollector.datap - (u_char *)receiver-&gt;sampleCollector.data;</span>
<span class="lineNum">     891 </span>                :<span class="lineCov">         15 : }</span>
<span class="lineNum">     892 </span>                :            : 
<span class="lineNum">     893 </span>                :            : /*_________________---------------------------__________________
<span class="lineNum">     894 </span>                :            :   _________________         sflError          __________________
<span class="lineNum">     895 </span>                :            :   -----------------___________________________------------------
<a name="896"><span class="lineNum">     896 </span>                :            : */</a>
<span class="lineNum">     897 </span>                :            : 
<span class="lineNum">     898 </span>                :<span class="lineNoCov">          0 : static void sflError(SFLReceiver *receiver, char *msg)</span>
<span class="lineNum">     899 </span>                :            : {
<span class="lineNum">     900 </span>                :<span class="lineNoCov">          0 :     sfl_agent_error(receiver-&gt;agent, &quot;receiver&quot;, msg);</span>
<span class="lineNum">     901 </span>                :<span class="lineNoCov">          0 :     resetSampleCollector(receiver);</span>
<span class="lineNum">     902 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     903 </span>                :            : 
<span class="lineNum">     904 </span>                :            : #endif  /* !__CHECKER__ */
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.12</a></td></tr>
  </table>
  <br>

</body>
</html>
