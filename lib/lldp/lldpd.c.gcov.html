<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - lib/lldp/lldpd.c</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">lib/lldp</a> - lldpd.c<span style="font-size: 80%;"> (source / <a href="lldpd.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">14</td>
            <td class="headerCovTableEntry">295</td>
            <td class="headerCovTableEntryLo">4.7 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-09-14 01:02:56</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">3</td>
            <td class="headerCovTableEntry">14</td>
            <td class="headerCovTableEntryLo">21.4 %</td>
          </tr>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">282</td>
            <td class="headerCovTableEntryLo">0.4 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : /* -*- mode: c; c-file-style: &quot;openbsd&quot; -*- */</a>
<span class="lineNum">       2 </span>                :            : /*
<span class="lineNum">       3 </span>                :            :  * Copyright (c) 2015 Nicira, Inc.
<span class="lineNum">       4 </span>                :            :  * Copyright (c) 2008 Vincent Bernat &lt;bernat@luffy.cx&gt;
<span class="lineNum">       5 </span>                :            :  *
<span class="lineNum">       6 </span>                :            :  * Permission to use, copy, modify, and/or distribute this software for any
<span class="lineNum">       7 </span>                :            :  * purpose with or without fee is hereby granted, provided that the above
<span class="lineNum">       8 </span>                :            :  * copyright notice and this permission notice appear in all copies.
<span class="lineNum">       9 </span>                :            :  *
<span class="lineNum">      10 </span>                :            :  * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES
<span class="lineNum">      11 </span>                :            :  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
<span class="lineNum">      12 </span>                :            :  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
<span class="lineNum">      13 </span>                :            :  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
<span class="lineNum">      14 </span>                :            :  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
<span class="lineNum">      15 </span>                :            :  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
<span class="lineNum">      16 </span>                :            :  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
<span class="lineNum">      17 </span>                :            :  */
<span class="lineNum">      18 </span>                :            : 
<span class="lineNum">      19 </span>                :            : #include &lt;config.h&gt;
<span class="lineNum">      20 </span>                :            : #include &quot;lldpd.h&quot;
<span class="lineNum">      21 </span>                :            : #include &lt;arpa/inet.h&gt;
<span class="lineNum">      22 </span>                :            : #include &lt;errno.h&gt;
<span class="lineNum">      23 </span>                :            : #include &lt;fcntl.h&gt;
<span class="lineNum">      24 </span>                :            : #include &lt;inttypes.h&gt;
<span class="lineNum">      25 </span>                :            : #include &lt;signal.h&gt;
<span class="lineNum">      26 </span>                :            : #include &lt;stdio.h&gt;
<span class="lineNum">      27 </span>                :            : #include &lt;sys/ioctl.h&gt;
<span class="lineNum">      28 </span>                :            : #include &lt;sys/socket.h&gt;
<span class="lineNum">      29 </span>                :            : #include &lt;sys/stat.h&gt;
<span class="lineNum">      30 </span>                :            : #include &lt;sys/time.h&gt;
<span class="lineNum">      31 </span>                :            : #include &lt;sys/types.h&gt;
<span class="lineNum">      32 </span>                :            : #include &lt;sys/wait.h&gt;
<span class="lineNum">      33 </span>                :            : #include &lt;unistd.h&gt;
<span class="lineNum">      34 </span>                :            : #ifndef _WIN32
<span class="lineNum">      35 </span>                :            : #include &lt;grp.h&gt;
<span class="lineNum">      36 </span>                :            : #include &lt;libgen.h&gt;
<span class="lineNum">      37 </span>                :            : #include &lt;pwd.h&gt;
<span class="lineNum">      38 </span>                :            : #include &lt;sys/select.h&gt;
<span class="lineNum">      39 </span>                :            : #include &lt;sys/utsname.h&gt;
<span class="lineNum">      40 </span>                :            : #endif
<span class="lineNum">      41 </span>                :            : #include &quot;compiler.h&quot;
<span class="lineNum">      42 </span>                :            : #include &quot;openvswitch/list.h&quot;
<span class="lineNum">      43 </span>                :            : #include &quot;packets.h&quot;
<a name="44"><span class="lineNum">      44 </span>                :            : #include &quot;timeval.h&quot;</a>
<span class="lineNum">      45 </span>                :            : 
<span class="lineNum">      46 </span>                :<span class="lineCov">       2462 : VLOG_DEFINE_THIS_MODULE(lldpd);</span>
<span class="lineNum">      47 </span>                :            : 
<span class="lineNum">      48 </span>                :            : static struct protocol protos[] =
<span class="lineNum">      49 </span>                :            : {
<span class="lineNum">      50 </span>                :            :     { LLDPD_MODE_LLDP, 1, &quot;LLDP&quot;, 'l', lldp_send, lldp_decode, NULL,
<span class="lineNum">      51 </span>                :            :       LLDP_MULTICAST_ADDR },
<span class="lineNum">      52 </span>                :            :     { 0, 0, &quot;any&quot;, ' ', NULL, NULL, NULL,
<span class="lineNum">      53 </span>                :            :       { { { 0,0,0,0,0,0 } } } }
<a name="54"><span class="lineNum">      54 </span>                :            : };</a>
<span class="lineNum">      55 </span>                :            : 
<span class="lineNum">      56 </span>                :<span class="lineCov">          1 : void lldpd_assign_cfg_to_protocols(struct lldpd *cfg)</span>
<span class="lineNum">      57 </span>                :            : {
<span class="lineNum">      58 </span>                :<span class="lineCov">          1 :     cfg-&gt;g_protocols = protos;</span>
<span class="lineNum">      59 </span>                :<span class="lineCov">          1 : }</span>
<a name="60"><span class="lineNum">      60 </span>                :            : </a>
<span class="lineNum">      61 </span>                :            : struct lldpd_hardware *
<span class="lineNum">      62 </span>                :<span class="lineNoCov">          0 : lldpd_get_hardware(struct lldpd *cfg, char *name, int index,</span>
<span class="lineNum">      63 </span>                :            :                    struct lldpd_ops *ops)
<span class="lineNum">      64 </span>                :            : {
<span class="lineNum">      65 </span>                :            :     struct lldpd_hardware *hw;
<span class="lineNum">      66 </span>                :            : 
<span class="lineNum">      67 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     LIST_FOR_EACH (hw, h_entries, &amp;cfg-&gt;g_hardware) {</span>
<span class="lineNum">      68 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!strcmp(hw-&gt;h_ifname, name) &amp;&amp; hw-&gt;h_ifindex == index</span>
<span class="lineNum">      69 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :             &amp;&amp; (!ops || ops == hw-&gt;h_ops)) {</span>
<span class="lineNum">      70 </span>                :<span class="lineNoCov">          0 :             return hw;</span>
<span class="lineNum">      71 </span>                :            :         }
<span class="lineNum">      72 </span>                :            :     }
<span class="lineNum">      73 </span>                :            : 
<span class="lineNum">      74 </span>                :<span class="lineNoCov">          0 :     return NULL;</span>
<span class="lineNum">      75 </span>                :            : }
<a name="76"><span class="lineNum">      76 </span>                :            : </a>
<span class="lineNum">      77 </span>                :            : struct lldpd_hardware *
<span class="lineNum">      78 </span>                :<span class="lineCov">          1 : lldpd_alloc_hardware(struct lldpd *cfg, char *name, int index)</span>
<span class="lineNum">      79 </span>                :            : {
<span class="lineNum">      80 </span>                :            :     struct lldpd_hardware *hw;
<span class="lineNum">      81 </span>                :            : 
<span class="lineNum">      82 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :     VLOG_DBG(&quot;allocate a new local hardware interface (%s)&quot;, name);</span>
<span class="lineNum">      83 </span>                :            : 
<span class="lineNum">      84 </span>                :<span class="lineCov">          1 :     hw = xzalloc(sizeof *hw);</span>
<span class="lineNum">      85 </span>                :<span class="lineCov">          1 :     hw-&gt;h_cfg = cfg;</span>
<span class="lineNum">      86 </span>                :<span class="lineCov">          1 :     ovs_strlcpy(hw-&gt;h_ifname, name, sizeof hw-&gt;h_ifname);</span>
<span class="lineNum">      87 </span>                :<span class="lineCov">          1 :     hw-&gt;h_ifindex = index;</span>
<span class="lineNum">      88 </span>                :<span class="lineCov">          1 :     hw-&gt;h_lport.p_chassis = CONTAINER_OF(ovs_list_front(&amp;cfg-&gt;g_chassis),</span>
<span class="lineNum">      89 </span>                :            :                                          struct lldpd_chassis, list);
<span class="lineNum">      90 </span>                :<span class="lineCov">          1 :     hw-&gt;h_lport.p_chassis-&gt;c_refcount++;</span>
<span class="lineNum">      91 </span>                :<span class="lineCov">          1 :     ovs_list_init(&amp;hw-&gt;h_rports);</span>
<span class="lineNum">      92 </span>                :            : 
<span class="lineNum">      93 </span>                :<span class="lineCov">          1 :     return hw;</span>
<span class="lineNum">      94 </span>                :            : }
<a name="95"><span class="lineNum">      95 </span>                :            : </a>
<span class="lineNum">      96 </span>                :            : struct lldpd_mgmt *
<span class="lineNum">      97 </span>                :<span class="lineNoCov">          0 : lldpd_alloc_mgmt(int family, void *addrptr, size_t addrsize, u_int32_t iface)</span>
<span class="lineNum">      98 </span>                :            : {
<span class="lineNum">      99 </span>                :            :     struct lldpd_mgmt *mgmt;
<span class="lineNum">     100 </span>                :            : 
<span class="lineNum">     101 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     VLOG_DBG(&quot;allocate a new management address (family: %d)&quot;, family);</span>
<span class="lineNum">     102 </span>                :            : 
<span class="lineNum">     103 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (family &lt;= LLDPD_AF_UNSPEC || family &gt;= LLDPD_AF_LAST) {</span>
<span class="lineNum">     104 </span>                :<span class="lineNoCov">          0 :         errno = EAFNOSUPPORT;</span>
<span class="lineNum">     105 </span>                :<span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">     106 </span>                :            :     }
<span class="lineNum">     107 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (addrsize &gt; LLDPD_MGMT_MAXADDRSIZE) {</span>
<span class="lineNum">     108 </span>                :<span class="lineNoCov">          0 :         errno = EOVERFLOW;</span>
<span class="lineNum">     109 </span>                :<span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">     110 </span>                :            :     }
<span class="lineNum">     111 </span>                :<span class="lineNoCov">          0 :     mgmt = xzalloc(sizeof *mgmt);</span>
<span class="lineNum">     112 </span>                :<span class="lineNoCov">          0 :     mgmt-&gt;m_family = family;</span>
<span class="lineNum">     113 </span>                :<span class="lineNoCov">          0 :     memcpy(&amp;mgmt-&gt;m_addr, addrptr, addrsize);</span>
<span class="lineNum">     114 </span>                :<span class="lineNoCov">          0 :     mgmt-&gt;m_addrsize = addrsize;</span>
<span class="lineNum">     115 </span>                :<span class="lineNoCov">          0 :     mgmt-&gt;m_iface = iface;</span>
<span class="lineNum">     116 </span>                :            : 
<span class="lineNum">     117 </span>                :<span class="lineNoCov">          0 :     return mgmt;</span>
<span class="lineNum">     118 </span>                :            : }
<a name="119"><span class="lineNum">     119 </span>                :            : </a>
<span class="lineNum">     120 </span>                :            : void
<span class="lineNum">     121 </span>                :<span class="lineNoCov">          0 : lldpd_hardware_cleanup(struct lldpd *cfg, struct lldpd_hardware *hardware)</span>
<span class="lineNum">     122 </span>                :            : {
<span class="lineNum">     123 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     VLOG_DBG(&quot;cleanup hardware port %s&quot;, hardware-&gt;h_ifname);</span>
<span class="lineNum">     124 </span>                :            : 
<span class="lineNum">     125 </span>                :<span class="lineNoCov">          0 :     lldpd_port_cleanup(&amp;hardware-&gt;h_lport, true);</span>
<span class="lineNum">     126 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (hardware-&gt;h_ops &amp;&amp; hardware-&gt;h_ops-&gt;cleanup) {</span>
<span class="lineNum">     127 </span>                :<span class="lineNoCov">          0 :         hardware-&gt;h_ops-&gt;cleanup(cfg, hardware);</span>
<span class="lineNum">     128 </span>                :            :     }
<span class="lineNum">     129 </span>                :<span class="lineNoCov">          0 :     free(hardware);</span>
<span class="lineNum">     130 </span>                :<span class="lineNoCov">          0 : }</span>
<a name="131"><span class="lineNum">     131 </span>                :            : </a>
<span class="lineNum">     132 </span>                :            : void
<span class="lineNum">     133 </span>                :<span class="lineNoCov">          0 : lldpd_cleanup(struct lldpd *cfg)</span>
<span class="lineNum">     134 </span>                :            : {
<span class="lineNum">     135 </span>                :            :     struct lldpd_hardware *hw, *hw_next;
<span class="lineNum">     136 </span>                :            :     struct lldpd_chassis *chassis, *chassis_next;
<span class="lineNum">     137 </span>                :            : 
<span class="lineNum">     138 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     VLOG_DBG(&quot;cleanup all ports&quot;);</span>
<span class="lineNum">     139 </span>                :            : 
<span class="lineNum">     140 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     LIST_FOR_EACH_SAFE (hw, hw_next, h_entries, &amp;cfg-&gt;g_hardware) {</span>
<span class="lineNum">     141 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!hw-&gt;h_flags) {</span>
<span class="lineNum">     142 </span>                :<span class="lineNoCov">          0 :             ovs_list_remove(&amp;hw-&gt;h_entries);</span>
<span class="lineNum">     143 </span>                :<span class="lineNoCov">          0 :             lldpd_remote_cleanup(hw, NULL, true);</span>
<span class="lineNum">     144 </span>                :<span class="lineNoCov">          0 :             lldpd_hardware_cleanup(cfg, hw);</span>
<span class="lineNum">     145 </span>                :            :         } else {
<span class="lineNum">     146 </span>                :<span class="lineNoCov">          0 :             lldpd_remote_cleanup(hw, NULL, false);</span>
<span class="lineNum">     147 </span>                :            :         }
<span class="lineNum">     148 </span>                :            :     }
<span class="lineNum">     149 </span>                :            : 
<span class="lineNum">     150 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     VLOG_DBG(&quot;cleanup all chassis&quot;);</span>
<span class="lineNum">     151 </span>                :            : 
<span class="lineNum">     152 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     LIST_FOR_EACH_SAFE (chassis, chassis_next, list, &amp;cfg-&gt;g_chassis) {</span>
<span class="lineNum">     153 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (chassis-&gt;c_refcount == 0) {</span>
<span class="lineNum">     154 </span>                :<span class="lineNoCov">          0 :             ovs_list_remove(&amp;chassis-&gt;list);</span>
<span class="lineNum">     155 </span>                :<span class="lineNoCov">          0 :             lldpd_chassis_cleanup(chassis, 1);</span>
<span class="lineNum">     156 </span>                :            :         }
<span class="lineNum">     157 </span>                :            :     }
<span class="lineNum">     158 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     159 </span>                :            : 
<span class="lineNum">     160 </span>                :            : /* Update chassis `ochassis' with values from `chassis'. The later one is not
<span class="lineNum">     161 </span>                :            :  * expected to be part of a list! It will also be wiped from memory.
<a name="162"><span class="lineNum">     162 </span>                :            :  */</a>
<span class="lineNum">     163 </span>                :            : static void
<span class="lineNum">     164 </span>                :<span class="lineNoCov">          0 : lldpd_move_chassis(struct lldpd_chassis *ochassis,</span>
<span class="lineNum">     165 </span>                :            :     struct lldpd_chassis *chassis)
<span class="lineNum">     166 </span>                :            : {
<span class="lineNum">     167 </span>                :            :     struct lldpd_mgmt *mgmt;
<span class="lineNum">     168 </span>                :<span class="lineNoCov">          0 :     int refcount = ochassis-&gt;c_refcount;</span>
<span class="lineNum">     169 </span>                :<span class="lineNoCov">          0 :     int index = ochassis-&gt;c_index;</span>
<span class="lineNum">     170 </span>                :            :     struct ovs_list listcopy;
<span class="lineNum">     171 </span>                :            : 
<span class="lineNum">     172 </span>                :            :     /* We want to keep refcount, index and list stuff from the current chassis
<span class="lineNum">     173 </span>                :            :      */
<span class="lineNum">     174 </span>                :<span class="lineNoCov">          0 :     memcpy(&amp;listcopy, &amp;ochassis-&gt;list, sizeof listcopy);</span>
<span class="lineNum">     175 </span>                :<span class="lineNoCov">          0 :     lldpd_chassis_cleanup(ochassis, 0);</span>
<span class="lineNum">     176 </span>                :            : 
<span class="lineNum">     177 </span>                :            :     /* Make the copy. */
<span class="lineNum">     178 </span>                :            :     /* WARNING: this is a kludgy hack, we need in-place copy and cannot use
<span class="lineNum">     179 </span>                :            :      * marshaling.
<span class="lineNum">     180 </span>                :            :      */
<span class="lineNum">     181 </span>                :<span class="lineNoCov">          0 :     memcpy(ochassis, chassis, sizeof *ochassis);</span>
<span class="lineNum">     182 </span>                :<span class="lineNoCov">          0 :     ovs_list_init(&amp;ochassis-&gt;c_mgmt);</span>
<span class="lineNum">     183 </span>                :            : 
<span class="lineNum">     184 </span>                :            :     /* Copy of management addresses */
<span class="lineNum">     185 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     LIST_FOR_EACH_POP (mgmt, m_entries, &amp;chassis-&gt;c_mgmt) {</span>
<span class="lineNum">     186 </span>                :<span class="lineNoCov">          0 :         ovs_list_insert(&amp;ochassis-&gt;c_mgmt, &amp;mgmt-&gt;m_entries);</span>
<span class="lineNum">     187 </span>                :            :     }
<span class="lineNum">     188 </span>                :            : 
<span class="lineNum">     189 </span>                :            :     /* Restore saved values */
<span class="lineNum">     190 </span>                :<span class="lineNoCov">          0 :     ochassis-&gt;c_refcount = refcount;</span>
<span class="lineNum">     191 </span>                :<span class="lineNoCov">          0 :     ochassis-&gt;c_index = index;</span>
<span class="lineNum">     192 </span>                :<span class="lineNoCov">          0 :     memcpy(&amp;ochassis-&gt;list, &amp;listcopy, sizeof ochassis-&gt;list);</span>
<span class="lineNum">     193 </span>                :            : 
<span class="lineNum">     194 </span>                :            :     /* Get rid of the new chassis */
<span class="lineNum">     195 </span>                :<span class="lineNoCov">          0 :     free(chassis);</span>
<span class="lineNum">     196 </span>                :<span class="lineNoCov">          0 : }</span>
<a name="197"><span class="lineNum">     197 </span>                :            : </a>
<span class="lineNum">     198 </span>                :            : static int
<span class="lineNum">     199 </span>                :<span class="lineNoCov">          0 : lldpd_guess_type(struct lldpd *cfg, char *frame, int s)</span>
<span class="lineNum">     200 </span>                :            : {
<span class="lineNum">     201 </span>                :            :     int i;
<span class="lineNum">     202 </span>                :            : 
<span class="lineNum">     203 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (s &lt; ETH_ADDR_LEN) {</span>
<span class="lineNum">     204 </span>                :<span class="lineNoCov">          0 :         return -1;</span>
<span class="lineNum">     205 </span>                :            :     }
<span class="lineNum">     206 </span>                :            : 
<span class="lineNum">     207 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (i = 0; cfg-&gt;g_protocols[i].mode != 0; i++) {</span>
<span class="lineNum">     208 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!cfg-&gt;g_protocols[i].enabled) {</span>
<span class="lineNum">     209 </span>                :<span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     210 </span>                :            :         }
<span class="lineNum">     211 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (cfg-&gt;g_protocols[i].guess == NULL) {</span>
<span class="lineNum">     212 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (memcmp(frame, &amp;cfg-&gt;g_protocols[i].mac, ETH_ADDR_LEN) == 0) {</span>
<span class="lineNum">     213 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 VLOG_DBG(&quot;guessed protocol is %s (from MAC address)&quot;,</span>
<span class="lineNum">     214 </span>                :            :                     cfg-&gt;g_protocols[i].name);
<span class="lineNum">     215 </span>                :<span class="lineNoCov">          0 :                 return cfg-&gt;g_protocols[i].mode;</span>
<span class="lineNum">     216 </span>                :            :             }
<span class="lineNum">     217 </span>                :            :         } else {
<span class="lineNum">     218 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (cfg-&gt;g_protocols[i].guess(frame, s)) {</span>
<span class="lineNum">     219 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 VLOG_DBG(&quot;guessed protocol is %s (from detector function)&quot;,</span>
<span class="lineNum">     220 </span>                :            :                     cfg-&gt;g_protocols[i].name);
<span class="lineNum">     221 </span>                :<span class="lineNoCov">          0 :                 return cfg-&gt;g_protocols[i].mode;</span>
<span class="lineNum">     222 </span>                :            :             }
<span class="lineNum">     223 </span>                :            :         }
<span class="lineNum">     224 </span>                :            :     }
<span class="lineNum">     225 </span>                :            : 
<span class="lineNum">     226 </span>                :<span class="lineNoCov">          0 :     return -1;</span>
<span class="lineNum">     227 </span>                :            : }
<a name="228"><span class="lineNum">     228 </span>                :            : </a>
<span class="lineNum">     229 </span>                :            : static void
<span class="lineNum">     230 </span>                :<span class="lineNoCov">          0 : lldpd_decode(struct lldpd *cfg, char *frame, int s,</span>
<span class="lineNum">     231 </span>                :            :              struct lldpd_hardware *hw)
<span class="lineNum">     232 </span>                :            : {
<span class="lineNum">     233 </span>                :            :     size_t listsize, i;
<span class="lineNum">     234 </span>                :<span class="lineNoCov">          0 :     struct lldpd_chassis *chassis, *ochassis = NULL;</span>
<span class="lineNum">     235 </span>                :            :     struct lldpd_port *port, *oport;
<span class="lineNum">     236 </span>                :<span class="lineNoCov">          0 :     int guess = LLDPD_MODE_LLDP;</span>
<span class="lineNum">     237 </span>                :            :     struct eth_header eheader;
<span class="lineNum">     238 </span>                :<span class="lineNoCov">          0 :     int count = 0;</span>
<span class="lineNum">     239 </span>                :<span class="lineNoCov">          0 :     bool found = false;</span>
<span class="lineNum">     240 </span>                :            : 
<span class="lineNum">     241 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     VLOG_DBG(&quot;decode a received frame on %s size %d&quot;, hw-&gt;h_ifname,s);</span>
<span class="lineNum">     242 </span>                :            : 
<span class="lineNum">     243 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (s &lt; sizeof(struct eth_header) + 4) {</span>
<span class="lineNum">     244 </span>                :            :         /* Too short, just discard it */
<span class="lineNum">     245 </span>                :<span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     246 </span>                :            :     }
<span class="lineNum">     247 </span>                :            : 
<span class="lineNum">     248 </span>                :            :     /* Decapsulate VLAN frames */
<span class="lineNum">     249 </span>                :<span class="lineNoCov">          0 :     memcpy(&amp;eheader, frame, sizeof eheader);</span>
<span class="lineNum">     250 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (eheader.eth_type == htons(ETH_TYPE_VLAN)) {</span>
<span class="lineNum">     251 </span>                :            :         /* VLAN decapsulation means to shift 4 bytes left the frame from
<span class="lineNum">     252 </span>                :            :          * offset 2 * ETH_ADDR_LEN
<span class="lineNum">     253 </span>                :            :          */
<span class="lineNum">     254 </span>                :<span class="lineNoCov">          0 :         memmove(frame + 2 * ETH_ADDR_LEN, frame + 2 * ETH_ADDR_LEN + 4,</span>
<span class="lineNum">     255 </span>                :<span class="lineNoCov">          0 :                 s - 2 * ETH_ADDR_LEN);</span>
<span class="lineNum">     256 </span>                :<span class="lineNoCov">          0 :         s -= 4;</span>
<span class="lineNum">     257 </span>                :            :     }
<span class="lineNum">     258 </span>                :            : 
<span class="lineNum">     259 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     LIST_FOR_EACH (oport, p_entries, &amp;hw-&gt;h_rports) {</span>
<span class="lineNum">     260 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (oport-&gt;p_lastframe &amp;&amp;</span>
<span class="lineNum">     261 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             oport-&gt;p_lastframe-&gt;size == s &amp;&amp;</span>
<span class="lineNum">     262 </span>                :<span class="lineNoCov">          0 :             !memcmp(oport-&gt;p_lastframe-&gt;frame, frame, s)) {</span>
<span class="lineNum">     263 </span>                :            :             /* Already received the same frame */
<span class="lineNum">     264 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             VLOG_DBG(&quot;duplicate frame, no need to decode&quot;);</span>
<span class="lineNum">     265 </span>                :<span class="lineNoCov">          0 :             oport-&gt;p_lastupdate = time_now();</span>
<span class="lineNum">     266 </span>                :<span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">     267 </span>                :            :         }
<span class="lineNum">     268 </span>                :            :     }
<span class="lineNum">     269 </span>                :            : 
<span class="lineNum">     270 </span>                :<span class="lineNoCov">          0 :     guess = lldpd_guess_type(cfg, frame, s);</span>
<span class="lineNum">     271 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     VLOG_DBG(&quot;guessed %d enabled:%d&quot;, guess, cfg-&gt;g_protocols[0].enabled);</span>
<span class="lineNum">     272 </span>                :            : 
<span class="lineNum">     273 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (i = 0; cfg-&gt;g_protocols[i].mode != 0; i++) {</span>
<span class="lineNum">     274 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!cfg-&gt;g_protocols[i].enabled) {</span>
<span class="lineNum">     275 </span>                :<span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     276 </span>                :            :         }
<span class="lineNum">     277 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (cfg-&gt;g_protocols[i].mode == guess) {</span>
<span class="lineNum">     278 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             VLOG_DBG(&quot;using decode function for %s protocol&quot;,</span>
<span class="lineNum">     279 </span>                :            :                 cfg-&gt;g_protocols[i].name);
<span class="lineNum">     280 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (cfg-&gt;g_protocols[i].decode(cfg, frame, s, hw, &amp;chassis, &amp;port)</span>
<span class="lineNum">     281 </span>                :            :                     == -1) {
<span class="lineNum">     282 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 VLOG_DBG(&quot;function for %s protocol did not &quot;</span>
<span class="lineNum">     283 </span>                :            :                          &quot;decode this frame&quot;,
<span class="lineNum">     284 </span>                :            :                          cfg-&gt;g_protocols[i].name);
<span class="lineNum">     285 </span>                :<span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     286 </span>                :            :             }
<span class="lineNum">     287 </span>                :<span class="lineNoCov">          0 :             chassis-&gt;c_protocol = port-&gt;p_protocol = cfg-&gt;g_protocols[i].mode;</span>
<span class="lineNum">     288 </span>                :<span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">     289 </span>                :            :       }
<span class="lineNum">     290 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :       VLOG_DBG(&quot; %&quot;PRIuSIZE &quot;mode:%d enabled:%d&quot;,</span>
<span class="lineNum">     291 </span>                :            :                i, cfg-&gt;g_protocols[i].mode, cfg-&gt;g_protocols[i].enabled);
<span class="lineNum">     292 </span>                :            :     }
<span class="lineNum">     293 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (cfg-&gt;g_protocols[i].mode == 0) {</span>
<span class="lineNum">     294 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         VLOG_DBG(&quot;unable to guess frame type on %s&quot;, hw-&gt;h_ifname);</span>
<span class="lineNum">     295 </span>                :<span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     296 </span>                :            :     }
<span class="lineNum">     297 </span>                :            : 
<span class="lineNum">     298 </span>                :            :     /* Do we already have the same MSAP somewhere? */
<span class="lineNum">     299 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     VLOG_DBG(&quot;search for the same MSAP&quot;);</span>
<span class="lineNum">     300 </span>                :            : 
<span class="lineNum">     301 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     LIST_FOR_EACH (oport, p_entries, &amp;hw-&gt;h_rports) {</span>
<span class="lineNum">     302 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (port-&gt;p_protocol == oport-&gt;p_protocol) {</span>
<span class="lineNum">     303 </span>                :<span class="lineNoCov">          0 :             count++;</span>
<span class="lineNum">     304 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (port-&gt;p_id_subtype == oport-&gt;p_id_subtype &amp;&amp;</span>
<span class="lineNum">     305 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 port-&gt;p_id_len == oport-&gt;p_id_len &amp;&amp;</span>
<span class="lineNum">     306 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 !memcmp(port-&gt;p_id, oport-&gt;p_id, port-&gt;p_id_len) &amp;&amp;</span>
<span class="lineNum">     307 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 chassis-&gt;c_id_subtype == oport-&gt;p_chassis-&gt;c_id_subtype &amp;&amp;</span>
<span class="lineNum">     308 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 chassis-&gt;c_id_len == oport-&gt;p_chassis-&gt;c_id_len &amp;&amp;</span>
<span class="lineNum">     309 </span>                :<span class="lineNoCov">          0 :                 !memcmp(chassis-&gt;c_id, oport-&gt;p_chassis-&gt;c_id,</span>
<span class="lineNum">     310 </span>                :<span class="lineNoCov">          0 :                         chassis-&gt;c_id_len)) {</span>
<span class="lineNum">     311 </span>                :<span class="lineNoCov">          0 :                 ochassis = oport-&gt;p_chassis;</span>
<span class="lineNum">     312 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 VLOG_DBG(&quot;MSAP is already known&quot;);</span>
<span class="lineNum">     313 </span>                :<span class="lineNoCov">          0 :                 found = true;</span>
<span class="lineNum">     314 </span>                :<span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     315 </span>                :            :             }
<span class="lineNum">     316 </span>                :            :         }
<span class="lineNum">     317 </span>                :            :     }
<span class="lineNum">     318 </span>                :            : 
<span class="lineNum">     319 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!found) {</span>
<span class="lineNum">     320 </span>                :<span class="lineNoCov">          0 :        oport = NULL;</span>
<span class="lineNum">     321 </span>                :            :     }
<span class="lineNum">     322 </span>                :            : 
<span class="lineNum">     323 </span>                :            :     /* Do we have room for a new MSAP? */
<span class="lineNum">     324 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!oport &amp;&amp; cfg-&gt;g_config.c_max_neighbors) {</span>
<span class="lineNum">     325 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (count == (cfg-&gt;g_config.c_max_neighbors - 1)) {</span>
<span class="lineNum">     326 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             VLOG_DBG(&quot;max neighbors %d reached for port %s, &quot;</span>
<span class="lineNum">     327 </span>                :            :                      &quot;dropping any new ones silently&quot;,
<span class="lineNum">     328 </span>                :            :                      cfg-&gt;g_config.c_max_neighbors,
<span class="lineNum">     329 </span>                :            :                      hw-&gt;h_ifname);
<span class="lineNum">     330 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         } else if (count &gt; cfg-&gt;g_config.c_max_neighbors - 1) {</span>
<span class="lineNum">     331 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             VLOG_DBG(&quot;too many neighbors for port %s, drop this new one&quot;,</span>
<span class="lineNum">     332 </span>                :            :                      hw-&gt;h_ifname);
<span class="lineNum">     333 </span>                :<span class="lineNoCov">          0 :             lldpd_port_cleanup(port, true);</span>
<span class="lineNum">     334 </span>                :<span class="lineNoCov">          0 :             lldpd_chassis_cleanup(chassis, true);</span>
<span class="lineNum">     335 </span>                :<span class="lineNoCov">          0 :             free(port);</span>
<span class="lineNum">     336 </span>                :<span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">     337 </span>                :            :         }
<span class="lineNum">     338 </span>                :            :     }
<span class="lineNum">     339 </span>                :            : 
<span class="lineNum">     340 </span>                :            :     /* No, but do we already know the system? */
<span class="lineNum">     341 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!oport) {</span>
<span class="lineNum">     342 </span>                :<span class="lineNoCov">          0 :         bool found = false;</span>
<span class="lineNum">     343 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         VLOG_DBG(&quot;MSAP is unknown, search for the chassis&quot;);</span>
<span class="lineNum">     344 </span>                :            : 
<span class="lineNum">     345 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         LIST_FOR_EACH (ochassis, list, &amp;cfg-&gt;g_chassis) {</span>
<span class="lineNum">     346 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if ((chassis-&gt;c_protocol == ochassis-&gt;c_protocol) &amp;&amp;</span>
<span class="lineNum">     347 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     (chassis-&gt;c_id_subtype == ochassis-&gt;c_id_subtype) &amp;&amp;</span>
<span class="lineNum">     348 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     (chassis-&gt;c_id_len == ochassis-&gt;c_id_len) &amp;&amp;</span>
<span class="lineNum">     349 </span>                :<span class="lineNoCov">          0 :                     (memcmp(chassis-&gt;c_id, ochassis-&gt;c_id,</span>
<span class="lineNum">     350 </span>                :<span class="lineNoCov">          0 :                     chassis-&gt;c_id_len) == 0)) {</span>
<span class="lineNum">     351 </span>                :<span class="lineNoCov">          0 :                     found = true;</span>
<span class="lineNum">     352 </span>                :<span class="lineNoCov">          0 :                     break;</span>
<span class="lineNum">     353 </span>                :            :                 }
<span class="lineNum">     354 </span>                :            :         }
<span class="lineNum">     355 </span>                :            : 
<span class="lineNum">     356 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!found) {</span>
<span class="lineNum">     357 </span>                :<span class="lineNoCov">          0 :             ochassis = NULL;</span>
<span class="lineNum">     358 </span>                :            :         }
<span class="lineNum">     359 </span>                :            :     }
<span class="lineNum">     360 </span>                :            : 
<span class="lineNum">     361 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (oport) {</span>
<span class="lineNum">     362 </span>                :            :         /* The port is known, remove it before adding it back */
<span class="lineNum">     363 </span>                :<span class="lineNoCov">          0 :         ovs_list_remove(&amp;oport-&gt;p_entries);</span>
<span class="lineNum">     364 </span>                :<span class="lineNoCov">          0 :         lldpd_port_cleanup(oport, 1);</span>
<span class="lineNum">     365 </span>                :<span class="lineNoCov">          0 :         free(oport);</span>
<span class="lineNum">     366 </span>                :            :     }
<span class="lineNum">     367 </span>                :            : 
<span class="lineNum">     368 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (ochassis) {</span>
<span class="lineNum">     369 </span>                :<span class="lineNoCov">          0 :         lldpd_move_chassis(ochassis, chassis);</span>
<span class="lineNum">     370 </span>                :<span class="lineNoCov">          0 :         chassis = ochassis;</span>
<span class="lineNum">     371 </span>                :            :     } else {
<span class="lineNum">     372 </span>                :            :         /* Chassis not known, add it */
<span class="lineNum">     373 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         VLOG_DBG(&quot;unknown chassis, add it to the list&quot;);</span>
<span class="lineNum">     374 </span>                :<span class="lineNoCov">          0 :         chassis-&gt;c_index = ++cfg-&gt;g_lastrid;</span>
<span class="lineNum">     375 </span>                :<span class="lineNoCov">          0 :         chassis-&gt;c_refcount = 0;</span>
<span class="lineNum">     376 </span>                :<span class="lineNoCov">          0 :         ovs_list_push_back(&amp;cfg-&gt;g_chassis, &amp;chassis-&gt;list);</span>
<span class="lineNum">     377 </span>                :<span class="lineNoCov">          0 :         listsize = ovs_list_size(&amp;cfg-&gt;g_chassis);</span>
<span class="lineNum">     378 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         VLOG_DBG(&quot;%&quot;PRIuSIZE &quot; different systems are known&quot;, listsize);</span>
<span class="lineNum">     379 </span>                :            :     }
<span class="lineNum">     380 </span>                :            : 
<span class="lineNum">     381 </span>                :            :     /* Add port */
<span class="lineNum">     382 </span>                :<span class="lineNoCov">          0 :     port-&gt;p_lastchange = port-&gt;p_lastupdate = time_now();</span>
<span class="lineNum">     383 </span>                :<span class="lineNoCov">          0 :     port-&gt;p_lastframe = xmalloc(s + sizeof(struct lldpd_frame));</span>
<span class="lineNum">     384 </span>                :<span class="lineNoCov">          0 :     port-&gt;p_lastframe-&gt;size = s;</span>
<span class="lineNum">     385 </span>                :<span class="lineNoCov">          0 :     memcpy(port-&gt;p_lastframe-&gt;frame, frame, s);</span>
<span class="lineNum">     386 </span>                :<span class="lineNoCov">          0 :     ovs_list_insert(&amp;hw-&gt;h_rports, &amp;port-&gt;p_entries);</span>
<span class="lineNum">     387 </span>                :            : 
<span class="lineNum">     388 </span>                :<span class="lineNoCov">          0 :     port-&gt;p_chassis = chassis;</span>
<span class="lineNum">     389 </span>                :<span class="lineNoCov">          0 :     port-&gt;p_chassis-&gt;c_refcount++;</span>
<span class="lineNum">     390 </span>                :            :     /* Several cases are possible :
<span class="lineNum">     391 </span>                :            :      *   1. chassis is new, its refcount was 0. It is now attached
<span class="lineNum">     392 </span>                :            :      *      to this port, its refcount is 1.
<span class="lineNum">     393 </span>                :            :      *   2. chassis already exists and was attached to another
<span class="lineNum">     394 </span>                :            :      *      port, we increase its refcount accordingly.
<span class="lineNum">     395 </span>                :            :      *   3. chassis already exists and was attached to the same
<span class="lineNum">     396 </span>                :            :      *      port, its refcount was decreased with
<span class="lineNum">     397 </span>                :            :      *      lldpd_port_cleanup() and is now increased again.
<span class="lineNum">     398 </span>                :            :      *
<span class="lineNum">     399 </span>                :            :      * In all cases, if the port already existed, it has been
<span class="lineNum">     400 </span>                :            :      * freed with lldpd_port_cleanup() and therefore, the refcount
<span class="lineNum">     401 </span>                :            :      * of the chassis that was attached to it is decreased.
<span class="lineNum">     402 </span>                :            :      */
<span class="lineNum">     403 </span>                :<span class="lineNoCov">          0 :     i = ovs_list_size(&amp;hw-&gt;h_rports);</span>
<span class="lineNum">     404 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     VLOG_DBG(&quot;%&quot;PRIuSIZE &quot; neighbors for %s&quot;, i, hw-&gt;h_ifname);</span>
<span class="lineNum">     405 </span>                :            : 
<span class="lineNum">     406 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!oport)  {</span>
<span class="lineNum">     407 </span>                :<span class="lineNoCov">          0 :         hw-&gt;h_insert_cnt++;</span>
<span class="lineNum">     408 </span>                :            :     }
<span class="lineNum">     409 </span>                :            : 
<span class="lineNum">     410 </span>                :<span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     411 </span>                :            : }
<a name="412"><span class="lineNum">     412 </span>                :            : </a>
<span class="lineNum">     413 </span>                :            : static void
<span class="lineNum">     414 </span>                :<span class="lineNoCov">          0 : lldpd_hide_ports(struct lldpd *cfg,</span>
<span class="lineNum">     415 </span>                :            :                  struct lldpd_hardware *hw,
<span class="lineNum">     416 </span>                :            :                  int mask) {
<span class="lineNum">     417 </span>                :            :     struct lldpd_port *port;
<span class="lineNum">     418 </span>                :            :     int protocols[LLDPD_MODE_MAX + 1];
<span class="lineNum">     419 </span>                :            :     char buffer[256];
<span class="lineNum">     420 </span>                :<span class="lineNoCov">          0 :     bool found = false;</span>
<span class="lineNum">     421 </span>                :            :     int i, j, k;
<span class="lineNum">     422 </span>                :            :     unsigned int min;
<span class="lineNum">     423 </span>                :            : 
<span class="lineNum">     424 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     VLOG_DBG(&quot;apply smart filter for port %s&quot;, hw-&gt;h_ifname);</span>
<span class="lineNum">     425 </span>                :            : 
<span class="lineNum">     426 </span>                :            :     /* Compute the number of occurrences of each protocol */
<span class="lineNum">     427 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (i = 0; i &lt;= LLDPD_MODE_MAX; i++) {</span>
<span class="lineNum">     428 </span>                :<span class="lineNoCov">          0 :         protocols[i] = 0;</span>
<span class="lineNum">     429 </span>                :            :     }
<span class="lineNum">     430 </span>                :            : 
<span class="lineNum">     431 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     LIST_FOR_EACH (port, p_entries, &amp;hw-&gt;h_rports) {</span>
<span class="lineNum">     432 </span>                :<span class="lineNoCov">          0 :         protocols[port-&gt;p_protocol]++;</span>
<span class="lineNum">     433 </span>                :            :     }
<span class="lineNum">     434 </span>                :            : 
<span class="lineNum">     435 </span>                :            :     /* Turn the protocols[] array into an array of
<span class="lineNum">     436 </span>                :            :      * enabled/disabled protocols. 1 means enabled, 0
<span class="lineNum">     437 </span>                :            :      * means disabled.
<span class="lineNum">     438 </span>                :            :      */
<span class="lineNum">     439 </span>                :<span class="lineNoCov">          0 :     min = (unsigned int) - 1;</span>
<span class="lineNum">     440 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (i = 0; i &lt;= LLDPD_MODE_MAX; i++) {</span>
<span class="lineNum">     441 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (protocols[i] &amp;&amp; (protocols[i] &lt; min)) {</span>
<span class="lineNum">     442 </span>                :<span class="lineNoCov">          0 :             min = protocols[i];</span>
<span class="lineNum">     443 </span>                :            :         }
<span class="lineNum">     444 </span>                :            :     }
<span class="lineNum">     445 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (i = 0; i &lt;= LLDPD_MODE_MAX; i++) {</span>
<span class="lineNum">     446 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (protocols[i] == min &amp;&amp; !found) {</span>
<span class="lineNum">     447 </span>                :            :             /* If we need a tie breaker, we take the first protocol only */
<span class="lineNum">     448 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (cfg-&gt;g_config.c_smart &amp; mask &amp;</span>
<span class="lineNum">     449 </span>                :            :                 (SMART_OUTGOING_ONE_PROTO | SMART_INCOMING_ONE_PROTO)) {
<span class="lineNum">     450 </span>                :<span class="lineNoCov">          0 :                 found = true;</span>
<span class="lineNum">     451 </span>                :            :             }
<span class="lineNum">     452 </span>                :<span class="lineNoCov">          0 :             protocols[i] = 1;</span>
<span class="lineNum">     453 </span>                :            :         } else {
<span class="lineNum">     454 </span>                :<span class="lineNoCov">          0 :             protocols[i] = 0;</span>
<span class="lineNum">     455 </span>                :            :         }
<span class="lineNum">     456 </span>                :            :     }
<span class="lineNum">     457 </span>                :            : 
<span class="lineNum">     458 </span>                :            :     /* We set the p_hidden flag to 1 if the protocol is disabled */
<span class="lineNum">     459 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     LIST_FOR_EACH (port, p_entries, &amp;hw-&gt;h_rports) {</span>
<span class="lineNum">     460 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (mask == SMART_OUTGOING) {</span>
<span class="lineNum">     461 </span>                :<span class="lineNoCov">          0 :             port-&gt;p_hidden_out = protocols[port-&gt;p_protocol] ? false : true;</span>
<span class="lineNum">     462 </span>                :            :         } else {
<span class="lineNum">     463 </span>                :<span class="lineNoCov">          0 :             port-&gt;p_hidden_in = protocols[port-&gt;p_protocol] ? false : true;</span>
<span class="lineNum">     464 </span>                :            :         }
<span class="lineNum">     465 </span>                :            :     }
<span class="lineNum">     466 </span>                :            : 
<span class="lineNum">     467 </span>                :            :     /* If we want only one neighbor, we take the first one */
<span class="lineNum">     468 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (cfg-&gt;g_config.c_smart &amp; mask &amp;</span>
<span class="lineNum">     469 </span>                :            :         (SMART_OUTGOING_ONE_NEIGH | SMART_INCOMING_ONE_NEIGH)) {
<span class="lineNum">     470 </span>                :<span class="lineNoCov">          0 :         found = false;</span>
<span class="lineNum">     471 </span>                :            : 
<span class="lineNum">     472 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         LIST_FOR_EACH (port, p_entries, &amp;hw-&gt;h_rports) {</span>
<span class="lineNum">     473 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (mask == SMART_OUTGOING) {</span>
<span class="lineNum">     474 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (found) {</span>
<span class="lineNum">     475 </span>                :<span class="lineNoCov">          0 :                     port-&gt;p_hidden_out = true;</span>
<span class="lineNum">     476 </span>                :            :                 }
<span class="lineNum">     477 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (!port-&gt;p_hidden_out) {</span>
<span class="lineNum">     478 </span>                :<span class="lineNoCov">          0 :                     found = true;</span>
<span class="lineNum">     479 </span>                :            :                 }
<span class="lineNum">     480 </span>                :            :             }
<span class="lineNum">     481 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (mask == SMART_INCOMING) {</span>
<span class="lineNum">     482 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (found) {</span>
<span class="lineNum">     483 </span>                :<span class="lineNoCov">          0 :                     port-&gt;p_hidden_in = true;</span>
<span class="lineNum">     484 </span>                :            :                 }
<span class="lineNum">     485 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (!port-&gt;p_hidden_in) {</span>
<span class="lineNum">     486 </span>                :<span class="lineNoCov">          0 :                     found = true;</span>
<span class="lineNum">     487 </span>                :            :                 }
<span class="lineNum">     488 </span>                :            :             }
<span class="lineNum">     489 </span>                :            :         }
<span class="lineNum">     490 </span>                :            :     }
<span class="lineNum">     491 </span>                :            : 
<span class="lineNum">     492 </span>                :            :     /* Print a debug message summarizing the operation */
<span class="lineNum">     493 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (i = 0; i &lt;= LLDPD_MODE_MAX; i++) {</span>
<span class="lineNum">     494 </span>                :<span class="lineNoCov">          0 :         protocols[i] = 0;</span>
<span class="lineNum">     495 </span>                :            :     }
<span class="lineNum">     496 </span>                :            : 
<span class="lineNum">     497 </span>                :<span class="lineNoCov">          0 :     k = j = 0;</span>
<span class="lineNum">     498 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     LIST_FOR_EACH (port, p_entries, &amp;hw-&gt;h_rports) {</span>
<span class="lineNum">     499 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!((mask == SMART_OUTGOING &amp;&amp; port-&gt;p_hidden_out) ||</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">     500 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :               (mask == SMART_INCOMING &amp;&amp; port-&gt;p_hidden_in))) {</span>
<span class="lineNum">     501 </span>                :<span class="lineNoCov">          0 :             k++;</span>
<span class="lineNum">     502 </span>                :<span class="lineNoCov">          0 :             protocols[port-&gt;p_protocol] = 1;</span>
<span class="lineNum">     503 </span>                :            :         }
<span class="lineNum">     504 </span>                :<span class="lineNoCov">          0 :         j++;</span>
<span class="lineNum">     505 </span>                :            :     }
<span class="lineNum">     506 </span>                :            : 
<span class="lineNum">     507 </span>                :<span class="lineNoCov">          0 :     buffer[0] = '\0';</span>
<span class="lineNum">     508 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (i = 0; cfg-&gt;g_protocols[i].mode != 0; i++) {</span>
<span class="lineNum">     509 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (cfg-&gt;g_protocols[i].enabled &amp;&amp;</span>
<span class="lineNum">     510 </span>                :<span class="lineNoCov">          0 :             protocols[cfg-&gt;g_protocols[i].mode]) {</span>
<span class="lineNum">     511 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (strlen(buffer) +</span>
<span class="lineNum">     512 </span>                :<span class="lineNoCov">          0 :                 strlen(cfg-&gt;g_protocols[i].name) + 3 &gt; sizeof(buffer)) {</span>
<span class="lineNum">     513 </span>                :            :                 /* Unlikely, our buffer is too small */
<span class="lineNum">     514 </span>                :<span class="lineNoCov">          0 :                 memcpy(buffer + sizeof(buffer) - 4, &quot;...&quot;, 4);</span>
<span class="lineNum">     515 </span>                :<span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     516 </span>                :            :             }
<span class="lineNum">     517 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (buffer[0]) {</span>
<span class="lineNum">     518 </span>                :<span class="lineNoCov">          0 :                 strncat(buffer, &quot;, &quot;, 2);</span>
<span class="lineNum">     519 </span>                :<span class="lineNoCov">          0 :                 strncat(buffer, cfg-&gt;g_protocols[i].name,</span>
<span class="lineNum">     520 </span>                :<span class="lineNoCov">          0 :                 strlen(cfg-&gt;g_protocols[i].name));</span>
<span class="lineNum">     521 </span>                :            :             }
<span class="lineNum">     522 </span>                :            :         }
<span class="lineNum">     523 </span>                :            :     }
<span class="lineNum">     524 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     VLOG_DBG(&quot;%s: %s: %d visible neighbors (out of %d)&quot;,</span>
<span class="lineNum">     525 </span>                :            :              hw-&gt;h_ifname,
<span class="lineNum">     526 </span>                :            :              (mask == SMART_OUTGOING) ? &quot;out filter&quot; : &quot;in filter&quot;,
<span class="lineNum">     527 </span>                :            :              k, j);
<span class="lineNum">     528 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     VLOG_DBG(&quot;%s: protocols: %s&quot;,</span>
<span class="lineNum">     529 </span>                :            :              hw-&gt;h_ifname, buffer[0] ? buffer : &quot;(none)&quot;);
<span class="lineNum">     530 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     531 </span>                :            : 
<a name="532"><span class="lineNum">     532 </span>                :            : /* Hide unwanted ports depending on smart mode set by the user */</a>
<span class="lineNum">     533 </span>                :            : static void
<span class="lineNum">     534 </span>                :<span class="lineNoCov">          0 : lldpd_hide_all(struct lldpd *cfg)</span>
<span class="lineNum">     535 </span>                :            : {
<span class="lineNum">     536 </span>                :            :     struct lldpd_hardware *hw;
<span class="lineNum">     537 </span>                :            : 
<span class="lineNum">     538 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!cfg-&gt;g_config.c_smart) {</span>
<span class="lineNum">     539 </span>                :<span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     540 </span>                :            :     }
<span class="lineNum">     541 </span>                :            : 
<span class="lineNum">     542 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     VLOG_DBG(&quot;apply smart filter results on all ports&quot;);</span>
<span class="lineNum">     543 </span>                :            : 
<span class="lineNum">     544 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     LIST_FOR_EACH (hw, h_entries, &amp;cfg-&gt;g_hardware) {</span>
<span class="lineNum">     545 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (cfg-&gt;g_config.c_smart &amp; SMART_INCOMING_FILTER) {</span>
<span class="lineNum">     546 </span>                :<span class="lineNoCov">          0 :             lldpd_hide_ports(cfg, hw, SMART_INCOMING);</span>
<span class="lineNum">     547 </span>                :            :         }
<span class="lineNum">     548 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (cfg-&gt;g_config.c_smart &amp; SMART_OUTGOING_FILTER) {</span>
<span class="lineNum">     549 </span>                :<span class="lineNoCov">          0 :             lldpd_hide_ports(cfg, hw, SMART_OUTGOING);</span>
<span class="lineNum">     550 </span>                :            :         }
<span class="lineNum">     551 </span>                :            :     }
<span class="lineNum">     552 </span>                :            : }
<a name="553"><span class="lineNum">     553 </span>                :            : </a>
<span class="lineNum">     554 </span>                :            : void
<span class="lineNum">     555 </span>                :<span class="lineNoCov">          0 : lldpd_recv(struct lldpd *cfg,</span>
<span class="lineNum">     556 </span>                :            :            struct lldpd_hardware *hw,
<span class="lineNum">     557 </span>                :            :            char *buffer,
<span class="lineNum">     558 </span>                :            :            size_t bufSize)
<span class="lineNum">     559 </span>                :            : {
<span class="lineNum">     560 </span>                :<span class="lineNoCov">          0 :     int n = bufSize;</span>
<span class="lineNum">     561 </span>                :            : 
<span class="lineNum">     562 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     VLOG_DBG(&quot;receive a frame on %s&quot;, hw-&gt;h_ifname);</span>
<span class="lineNum">     563 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (cfg-&gt;g_config.c_paused) {</span>
<span class="lineNum">     564 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         VLOG_DBG(&quot;paused, ignore the frame on %s&quot;, hw-&gt;h_ifname);</span>
<span class="lineNum">     565 </span>                :<span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     566 </span>                :            :     }
<span class="lineNum">     567 </span>                :<span class="lineNoCov">          0 :     hw-&gt;h_rx_cnt++;</span>
<span class="lineNum">     568 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     VLOG_DBG(&quot;decode received frame on %s h_rx_cnt=%&quot; PRIu64,</span>
<span class="lineNum">     569 </span>                :            :              hw-&gt;h_ifname, hw-&gt;h_rx_cnt);
<span class="lineNum">     570 </span>                :<span class="lineNoCov">          0 :     lldpd_decode(cfg, buffer, n, hw);</span>
<span class="lineNum">     571 </span>                :<span class="lineNoCov">          0 :     lldpd_hide_all(cfg); /* Immediatly hide */</span>
<span class="lineNum">     572 </span>                :            : }
<a name="573"><span class="lineNum">     573 </span>                :            : </a>
<span class="lineNum">     574 </span>                :            : uint32_t
<span class="lineNum">     575 </span>                :<span class="lineNoCov">          0 : lldpd_send(struct lldpd_hardware *hw, struct dp_packet *p)</span>
<span class="lineNum">     576 </span>                :            : {
<span class="lineNum">     577 </span>                :<span class="lineNoCov">          0 :     struct lldpd *cfg = hw-&gt;h_cfg;</span>
<span class="lineNum">     578 </span>                :            :     struct lldpd_port *port;
<span class="lineNum">     579 </span>                :<span class="lineNoCov">          0 :     int i, sent = 0;</span>
<span class="lineNum">     580 </span>                :<span class="lineNoCov">          0 :     int lldp_size = 0;</span>
<span class="lineNum">     581 </span>                :            : 
<span class="lineNum">     582 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (cfg-&gt;g_config.c_receiveonly || cfg-&gt;g_config.c_paused) {</span>
<span class="lineNum">     583 </span>                :<span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     584 </span>                :            :     }
<span class="lineNum">     585 </span>                :            : #ifndef _WIN32
<span class="lineNum">     586 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if ((hw-&gt;h_flags &amp; IFF_RUNNING) == 0) {</span>
<span class="lineNum">     587 </span>                :<span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     588 </span>                :            :     }
<span class="lineNum">     589 </span>                :            : #endif
<span class="lineNum">     590 </span>                :            : 
<span class="lineNum">     591 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (i = 0; cfg-&gt;g_protocols[i].mode != 0; i++) {</span>
<span class="lineNum">     592 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!cfg-&gt;g_protocols[i].enabled) {</span>
<span class="lineNum">     593 </span>                :<span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     594 </span>                :            :         }
<span class="lineNum">     595 </span>                :            : 
<span class="lineNum">     596 </span>                :            :         /* We send only if we have at least one remote system
<span class="lineNum">     597 </span>                :            :          * speaking this protocol or if the protocol is forced */
<span class="lineNum">     598 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (cfg-&gt;g_protocols[i].enabled &gt; 1) {</span>
<span class="lineNum">     599 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if ((lldp_size = cfg-&gt;g_protocols[i].send(cfg, hw, p)) != -E2BIG) {</span>
<span class="lineNum">     600 </span>                :<span class="lineNoCov">          0 :                 sent++;</span>
<span class="lineNum">     601 </span>                :<span class="lineNoCov">          0 :                 continue;</span>
<span class="lineNum">     602 </span>                :            :             } else {
<span class="lineNum">     603 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 VLOG_DBG(&quot;send PDU on %s failed E2BIG&quot;, hw-&gt;h_ifname);</span>
<span class="lineNum">     604 </span>                :<span class="lineNoCov">          0 :                 continue;</span>
<span class="lineNum">     605 </span>                :            :             }
<span class="lineNum">     606 </span>                :            :         }
<span class="lineNum">     607 </span>                :            : 
<span class="lineNum">     608 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         LIST_FOR_EACH (port, p_entries, &amp;hw-&gt;h_rports) {</span>
<span class="lineNum">     609 </span>                :            :             /* If this remote port is disabled, we don't consider it */
<span class="lineNum">     610 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (port-&gt;p_hidden_out) {</span>
<span class="lineNum">     611 </span>                :<span class="lineNoCov">          0 :                 continue;</span>
<span class="lineNum">     612 </span>                :            :             }
<span class="lineNum">     613 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (port-&gt;p_protocol == cfg-&gt;g_protocols[i].mode) {</span>
<span class="lineNum">     614 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 VLOG_DBG(&quot;send PDU on %s with protocol %s&quot;,</span>
<span class="lineNum">     615 </span>                :            :                          hw-&gt;h_ifname, cfg-&gt;g_protocols[i].name);
<span class="lineNum">     616 </span>                :<span class="lineNoCov">          0 :                 lldp_size = cfg-&gt;g_protocols[i].send(cfg, hw, p);</span>
<span class="lineNum">     617 </span>                :<span class="lineNoCov">          0 :                 sent++;</span>
<span class="lineNum">     618 </span>                :<span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     619 </span>                :            :             }
<span class="lineNum">     620 </span>                :            :         }
<span class="lineNum">     621 </span>                :            :     }
<span class="lineNum">     622 </span>                :            : 
<span class="lineNum">     623 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!sent) {</span>
<span class="lineNum">     624 </span>                :            :         /* Nothing was sent for this port, let's speak the first
<span class="lineNum">     625 </span>                :            :          * available protocol.
<span class="lineNum">     626 </span>                :            :          */
<span class="lineNum">     627 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (i = 0; cfg-&gt;g_protocols[i].mode != 0; i++) {</span>
<span class="lineNum">     628 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (!cfg-&gt;g_protocols[i].enabled) {</span>
<span class="lineNum">     629 </span>                :<span class="lineNoCov">          0 :                 continue;</span>
<span class="lineNum">     630 </span>                :            :             }
<span class="lineNum">     631 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             VLOG_DBG(&quot;fallback to protocol %s for %s&quot;,</span>
<span class="lineNum">     632 </span>                :            :                      cfg-&gt;g_protocols[i].name, hw-&gt;h_ifname);
<span class="lineNum">     633 </span>                :<span class="lineNoCov">          0 :             lldp_size = cfg-&gt;g_protocols[i].send(cfg, hw, p);</span>
<span class="lineNum">     634 </span>                :<span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">     635 </span>                :            :         }
<span class="lineNum">     636 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (cfg-&gt;g_protocols[i].mode == 0) {</span>
<span class="lineNum">     637 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             VLOG_WARN(&quot;no protocol enabled, dunno what to send&quot;);</span>
<span class="lineNum">     638 </span>                :            :         }
<span class="lineNum">     639 </span>                :            :     }
<span class="lineNum">     640 </span>                :            : 
<span class="lineNum">     641 </span>                :<span class="lineNoCov">          0 :     return lldp_size;</span>
<span class="lineNum">     642 </span>                :            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.12</a></td></tr>
  </table>
  <br>

</body>
</html>
